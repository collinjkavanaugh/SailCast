<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SailCast â€“ Port Phillip Bay</title>

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<!-- Leaflet (map) â€” single include -->
<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
:root{
  --bg:#f4f6fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
  --accent:#0f172a;--accent2:#2563eb;
  --good:#16a34a;--ok:#f59e0b;--bad:#ef4444;
  --chip:#eef2ff;
}
body{background:var(--bg);color:var(--text)}
a{color:inherit}
.wrap{max-width:1100px;margin:18px auto 40px;padding:0 14px}

.topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
.pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:7px 12px;border-radius:999px;border:1px solid var(--line);
  background:#fff;color:var(--accent);font-weight:600;font-size:12px;
  box-shadow:0 1px 0 rgba(0,0,0,.03);
  cursor:pointer;
}
.pill.active{background:var(--accent);border-color:var(--accent);color:#fff}
.pill .dot{width:8px;height:8px;border-radius:50%;background:var(--good)}
.pill:not(.active) .dot{background:#c7d2fe}

.hero{
  background:var(--card);border:1px solid var(--line);border-radius:16px;
  padding:18px 18px 14px;box-shadow:0 6px 22px rgba(15,23,42,.06);
}
.hero-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
.hero h1{font-size:14px;letter-spacing:.12em;color:#64748b;text-transform:uppercase}
.hero .date{color:var(--muted);font-size:12px;margin-top:2px}
.rating{display:flex;align-items:center;gap:10px;margin:10px 0 6px}
.rating .label{font-size:28px;font-weight:800;color:var(--good);letter-spacing:.02em}
.rating .bars{display:flex;gap:4px}
.rating .bar{width:24px;height:10px;border-radius:3px;background:#d1d5db}
.rating .bar.on{background:var(--good)}
.subtitle{color:#475569;font-size:12.5px;line-height:1.45;margin-bottom:14px}

.metrics{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:0;border-top:1px solid var(--line);margin-top:10px
}
.metric{padding:14px 12px;border-right:1px solid var(--line)}
.metric:last-child{border-right:none}
.metric .k{font-size:10px;color:#64748b;font-weight:700;letter-spacing:.12em}
.metric .v{margin-top:6px;font-size:22px;font-weight:800}
.metric .s{margin-top:3px;font-size:11.5px;color:#64748b}
.metric .mono{font-family:"Space Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

.card{
  background:var(--card);border:1px solid var(--line);border-radius:16px;
  margin-top:14px;box-shadow:0 6px 22px rgba(15,23,42,.06);
}
.tabs{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--line)}
.tab{
  padding:7px 10px;border-radius:999px;border:1px solid var(--line);
  background:#fff;color:#0f172a;font-weight:700;font-size:11px;cursor:pointer;
  display:inline-flex;align-items:center;gap:8px
}
.tab.active{background:var(--chip);border-color:#c7d2fe}
.tab .tDot{width:7px;height:7px;border-radius:50%;background:var(--good)}
.tab:not(.active) .tDot{background:#cbd5e1}
.timeline{padding:12px 14px 10px}
.timeline-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
.timeline-title{font-size:10px;color:#64748b;font-weight:800;letter-spacing:.12em;text-transform:uppercase}
.timeline-note{font-size:10px;color:#64748b}
.barsRow{display:grid;grid-template-columns:repeat(16,1fr);gap:6px;align-items:end;margin-top:8px}
.hourLbls{display:grid;grid-template-columns:repeat(16,1fr);gap:6px;margin-top:6px}
.hourLbls div{font-size:10px;color:#94a3b8;text-align:center}

/* timeline bars: now scaled height + more "Surfline" look */
.tbar{
  border-radius:10px;
  position:relative;
  overflow:hidden;
  border:1px solid rgba(15,23,42,.10);
  height: calc(var(--h, 0.35) * 130px);
  min-height:42px;
  box-shadow:0 10px 24px rgba(15,23,42,.08);
}
.tbar.good{background:rgba(34,197,94,.85)}
.tbar.ok{background:rgba(245,158,11,.85)}
.tbar.bad{background:rgba(239,68,68,.80)}
/* optional purple "featured hour" feel (you can remove later) */
.tbar.purple{background:rgba(139,92,246,.85)}

.tbar::after{
  content:"";
  position:absolute;inset:0;
  background:linear-gradient(to top, rgba(255,255,255,.20), rgba(255,255,255,0) 55%);
  pointer-events:none;
}

.tbar .topRow{
  position:absolute;left:0;right:0;top:6px;
  display:flex;align-items:center;justify-content:center;gap:6px;
  color:rgba(15,23,42,.72);
  font-size:12px;font-weight:700;
}
.tbar .val{
  position:absolute;left:0;right:0;bottom:7px;
  text-align:center;
  font-size:11px;font-weight:900;color:#0b1220;
  text-shadow:0 1px 0 rgba(255,255,255,.25);
}
.wxIcon{font-size:13px;line-height:1}
.arrow{
  width:14px;height:14px;
  display:inline-block;
  transform:rotate(var(--rot, 0deg));
}
.arrow svg{display:block}
.arrow path{fill:rgba(15,23,42,.72)}

.best{padding:10px 14px 12px;border-top:1px solid var(--line);color:#334155;font-size:12px}
.best small{display:block;color:#64748b;margin-top:5px;line-height:1.4}

.map-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
.map-head h3{font-size:11px;color:#64748b;font-weight:900;letter-spacing:.12em;text-transform:uppercase}
.layerBtns{display:flex;gap:6px}
.layerBtns button{
  border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;
  font-size:10px;font-weight:800;color:#0f172a;cursor:pointer
}
.layerBtns button.active{background:var(--accent);border-color:var(--accent);color:#fff}
.map-wrap{position:relative}
#wxMap{height:360px;border-radius:0 0 16px 16px}
.map-legend{
  position:absolute;left:12px;bottom:12px;background:rgba(255,255,255,.92);
  border:1px solid var(--line);border-radius:10px;padding:10px 10px 8px;
  box-shadow:0 8px 22px rgba(15,23,42,.16);backdrop-filter:blur(6px);
  width:160px
}
.map-legend .lTitle{font-size:10px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:#334155;margin-bottom:8px}
.scale{display:flex;gap:2px;align-items:center;margin-top:6px}
.scale span{height:8px;flex:1;border-radius:2px;background:#e2e8f0}
.scaleLabels{display:flex;justify-content:space-between;font-size:10px;color:#64748b;margin-top:6px}
.footer{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;padding:10px 12px;font-size:10px;color:#94a3b8;border-top:1px solid var(--line)}
.badge{padding:4px 8px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0;color:#64748b;font-weight:800}
.status{
  margin-bottom:10px;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #fecaca;
  background:#fef2f2;
  color:#991b1b;
  font-size:12px;
  display:none;
}
.tbar:focus-visible{
  outline:2px solid var(--accent2);
  outline-offset:2px;
}

@media (max-width:980px){
  .metrics{grid-template-columns:repeat(2,1fr)}
  .metric:nth-child(2){border-right:none}
  .metric:nth-child(1),.metric:nth-child(2){border-bottom:1px solid var(--line)}
  .barsRow,.hourLbls{grid-template-columns:repeat(8,1fr)}
}
</style>
</head>

<body>
<div class="wrap">

  <div class="status" id="statusMsg" role="status" aria-live="polite"></div>

  <div class="topbar">
    <div class="pills" id="spotPills"></div>
    <button class="pill" id="btnMapPin" title="Use map click"><span class="dot"></span> Use map pin forecast</button>
  </div>

  <section class="hero">
    <div class="hero-top">
      <div>
        <h1>Sailing Conditions</h1>
        <div class="rating">
          <div class="label" id="ratingLabel">GREAT</div>
          <div class="bars" id="ratingBars"></div>
        </div>
        <div class="subtitle" id="ratingSubtitle">
          Rearrange your day for this. Clean, steady wind in the ideal range, light gusts, flat-to-small chop, and a favourable direction.
        </div>
      </div>
      <div class="date" id="heroDate">â€”</div>
    </div>

    <div class="metrics">
      <div class="metric">
        <div class="k">WIND</div>
        <div class="v"><span id="mWind">â€”</span><span class="mono"> kts</span> <span class="mono" id="mWindCard">â€”</span></div>
        <div class="s"><span id="mGust">â€”</span> kts gusts</div>
      </div>
      <div class="metric">
        <div class="k">WAVES</div>
        <div class="v"><span id="mWave">â€”</span><span class="mono"> m</span></div>
        <div class="s"><span id="mPeriod">â€”</span> s period Â· Port Phillip Bay</div>
      </div>
      <div class="metric">
        <div class="k">WIND DIRECTION</div>
        <div class="v"><span id="mDirDeg">â€”</span><span class="mono">Â°</span></div>
        <div class="s"><span id="mDirCard">â€”</span></div>
      </div>
      <div class="metric">
        <div class="k">DAY TEMPERATURE</div>
        <div class="v"><span id="mTmax">â€”</span><span class="mono">Â°c</span> <span class="mono"> </span> <span id="mTmin">â€”</span><span class="mono">Â°c</span></div>
        <div class="s" id="mTempNote">â€”</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="tabs" id="dayTabs"></div>

    <div class="timeline">
      <div class="timeline-head">
        <div class="timeline-title">Conditions Timeline Â· click to inspect</div>
        <div class="timeline-note" id="timelineNote">â€”</div>
      </div>

      <div class="hourLbls" id="hourLbls"></div>
      <div class="barsRow" id="barsRow"></div>
    </div>

    <div class="best" id="bestWindow">
      Best sailing window: â€”
      <small id="bestDetail">â€”</small>
    </div>
  </section>

  <section class="card">
    <div class="map-head">
      <h3>Wind & Weather Map</h3>
      <div class="layerBtns">
        <button data-layer="wind" class="active">WIND</button>
        <button data-layer="gust">GUSTS</button>
        <button data-layer="rain">RAIN</button>
        <button data-layer="waves">WAVES</button>
      </div>
    </div>
    <div class="map-wrap">
      <div id="wxMap"></div>
      <div class="map-legend" id="legend">
        <div class="lTitle" id="legendTitle">Wind speed (kts)</div>
        <div class="scale" id="legendScale"></div>
        <div class="scaleLabels"><span id="legendMin">0</span><span id="legendMax">30</span></div>
      </div>
    </div>
    <div class="footer">
      <div id="footerLeft">Showing: â€”</div>
      <div class="badge" id="footerRight">Open-Meteo Â· Leaflet Â· OSM</div>
    </div>
  </section>

</div>

<script>
/**
 * Changes in this version (focused on ONE thing: timeline bars/icons):
 * - Timeline bars are scaled by wind speed (variable height).
 * - Each hour shows a wind-direction arrow rotated by wind dir.
 * - Each hour shows a simple weather icon derived from weathercode.
 *
 * NOTE: Your /api/forecast should ideally request knots (windspeed_unit=kn),
 * otherwise UI labels may not match the underlying units.
 */

const SPOTS = [
  {name:"RMYS St Kilda Marina", lat:-37.8676, lon:144.9741},
  {name:"Savages Wharf, Williamstown", lat:-37.8629, lon:144.9006},
  {name:"Sandringham Yacht Club", lat:-37.9521, lon:145.0102},
  {name:"Royal Brighton Yacht Club", lat:-37.9146, lon:144.9878},
  {name:"Blairgowrie Yacht Squadron", lat:-38.3629, lon:144.7766}
];

let ACTIVE_SPOT = 0;
let ACTIVE_DAY = 0;
let ACTIVE_LAYER = "wind";
let MAP, MARKER;
let USING_CUSTOM_PIN = false;
let CUSTOM_PIN = null;

let FORECAST = [];

function el(id){return document.getElementById(id);}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

function showStatus(msg){
  const n = el("statusMsg");
  n.textContent = msg;
  n.style.display = msg ? "block" : "none";
}

function labelForDay(dateStr, idx){
  if(idx===0) return "Today";
  if(idx===1) return "Tomorrow";
  const dt = new Date(`${dateStr}T00:00:00`);
  const weekday = dt.toLocaleDateString("en-AU", { weekday: "short" });
  return `${weekday} ${dateStr.slice(8,10)}/${dateStr.slice(5,7)}`;
}

function degToCardinal(deg){
  const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  const idx=Math.round(((deg%360)+360)%360/22.5)%16;
  return dirs[idx];
}

function wxEmoji(code){
  // Open-Meteo weathercode mapping (coarse buckets only)
  if(code===0) return "â˜€ï¸";
  if(code===1 || code===2) return "ðŸŒ¤ï¸";
  if(code===3) return "â˜ï¸";
  if(code===45 || code===48) return "ðŸŒ«ï¸";
  if((code>=51 && code<=57) || (code>=61 && code<=67) || (code>=80 && code<=82)) return "ðŸŒ§ï¸";
  if(code>=71 && code<=77) return "â„ï¸";
  if(code>=95) return "â›ˆï¸";
  return "â€¢";
}

function ratingFromNow(now){
  const wind=now.ws, gust=now.g, wave=now.wv ?? 0, dir=now.wd;
  let score=0;
  if(wind>=10 && wind<=18) score+=3;
  else if(wind>=8 && wind<=22) score+=2;
  else if(wind>=6) score+=1;

  if((gust-wind)<=8) score+=2;
  else if((gust-wind)<=12) score+=1;

  if(wave<=0.6) score+=2;
  else if(wave<=1.0) score+=1;

  const goodDir = (dir>=150 && dir<=260);
  if(goodDir) score+=2;

  if(score>=8) return {label:"GREAT",color:"good",bars:4,desc:"Rearrange your day for this. Clean, steady wind in the ideal range, light gusts, flat-to-small chop, and a favourable direction."};
  if(score>=6) return {label:"GOOD",color:"good",bars:3,desc:"Worth going. Conditions look solid with manageable variability."};
  if(score>=4) return {label:"OKAY",color:"ok",bars:2,desc:"Sailable, but expect compromises (gusts, direction, or a bumpier surface)."};
  return {label:"POOR",color:"bad",bars:1,desc:"Not idealâ€”consider delaying or keeping it short and close to home."};
}

function renderSpotPills(){
  const wrap=el("spotPills");
  wrap.innerHTML="";
  SPOTS.forEach((s,i)=>{
    const b=document.createElement("button");
    b.className="pill"+(i===ACTIVE_SPOT?" active":"");
    b.innerHTML=`<span class="dot"></span> ${s.name}`;
    b.onclick=()=>{
      USING_CUSTOM_PIN = false;
      CUSTOM_PIN = null;
      ACTIVE_SPOT=i;
      ACTIVE_DAY=0;
      loadAndRender();
    };
    wrap.appendChild(b);
  });
}

function renderRating(r){
  el("ratingLabel").textContent=r.label;
  el("ratingLabel").style.color = r.color==="good"? "var(--good)" : (r.color==="ok" ? "var(--ok)" : "var(--bad)");
  el("ratingSubtitle").textContent=r.desc;

  const bars=el("ratingBars");bars.innerHTML="";
  for(let i=0;i<5;i++){
    const d=document.createElement("div");
    d.className="bar"+(i<r.bars?" on":"");
    if(i<r.bars){
      d.style.background = r.color==="good"? "var(--good)" : (r.color==="ok" ? "var(--ok)" : "var(--bad)");
    }
    bars.appendChild(d);
  }
}

function renderHero(day){
  const now=day.hours[0] || {ws:0,g:0,wd:0,wv:0,wp:0};
  const r=ratingFromNow(now);
  renderRating(r);

  el("heroDate").textContent = `${day.label} Â· ${(USING_CUSTOM_PIN ? "Custom map pin" : SPOTS[ACTIVE_SPOT].name)} Â· Intermediate`;

  el("mWind").textContent = Math.round(now.ws||0);
  el("mWindCard").textContent = degToCardinal(now.wd||0);
  el("mGust").textContent = Math.round(now.g||0);

  el("mWave").textContent = (now.wv!=null? (Math.round(now.wv*10)/10).toFixed(1):"â€”");
  el("mPeriod").textContent = (now.wp!=null? Math.round(now.wp):"â€”");

  el("mDirDeg").textContent = Math.round(now.wd||0);
  el("mDirCard").textContent = `${degToCardinal(now.wd||0)}`;

  el("mTmax").textContent = day.tmax!=null ? Math.round(day.tmax) : "â€”";
  el("mTmin").textContent = day.tmin!=null ? Math.round(day.tmin) : "â€”";
  el("mTempNote").textContent = day.rainSum!=null && day.rainSum>0 ? "Some rain expected" : "No rain expected";
}

function renderDayTabs(){
  const tabs=el("dayTabs");tabs.innerHTML="";
  FORECAST.forEach((d,i)=>{
    const t=document.createElement("div");
    t.className="tab"+(i===ACTIVE_DAY?" active":"");
    t.innerHTML=`<span class="tDot"></span> ${d.label}`;
    t.onclick=()=>{ACTIVE_DAY=i;renderAll();};
    tabs.appendChild(t);
  });
}

function colorForWind(ws){
  if(ws>=10 && ws<=18) return "good";
  if(ws>=7) return "ok";
  return "bad";
}

function windHeightFactor(ws){
  // map wind speed to [0.25..1.0] for bar height
  const max = 26; // tune as you like
  const v = clamp((ws||0) / max, 0, 1);
  return 0.25 + v * 0.75;
}

function arrowSvg(){
  return `
    <span class="arrow">
      <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
        <path d="M12 2l6 8h-4v10h-4V10H6l6-8z"></path>
      </svg>
    </span>
  `;
}

function renderTimeline(day){
  const slots = day.hours.slice(0,16);
  const hourLbls=el("hourLbls");
  const barsRow=el("barsRow");
  hourLbls.innerHTML="";
  barsRow.innerHTML="";

  slots.forEach((h, idx)=>{
    const lab=document.createElement("div");
    const hr = h.h;
    const disp = (hr===12?"12p": (hr>12? (hr-12)+"p" : hr+"a"));
    lab.textContent=disp;
    hourLbls.appendChild(lab);

    const b=document.createElement("div");
    const c=colorForWind(h.ws);
    b.className="tbar "+c;

    // optional: add a single purple "highlight" bar sometimes (remove if you hate it)
    // if(idx===10) b.classList.add("purple");

    const hFactor = windHeightFactor(h.ws);
    b.style.setProperty("--h", hFactor);

    const rot = `${Math.round(h.wd||0)}deg`;
    const wx = wxEmoji(h.code);

    const waveTxt = (h.wv==null ? "â€”" : (Math.round(h.wv*10)/10).toFixed(1)) + " m";
    const tempTxt = (h.t==null ? "â€”" : Math.round(h.t)) + "Â°c";
    const rainTxt = (h.pr==null ? "â€”" : (Math.round(h.pr*10)/10).toFixed(1)) + " mm";

    b.innerHTML = `
      <div class="topRow" style="--rot:${rot}">
        <span class="wxIcon">${wx}</span>
        <span class="arrow" style="--rot:${rot}">
          <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
            <path d="M12 2l6 8h-4v10h-4V10H6l6-8z"></path>
          </svg>
        </span>
      </div>
      <div class="val">${Math.round(h.ws||0)}</div>
    `;
    b.tabIndex = 0;
    b.role = "button";
    b.setAttribute("aria-label", `${disp}, wind ${Math.round(h.ws||0)} knots, gust ${Math.round(h.g||0)} knots, waves ${waveTxt}, rain ${rainTxt}, direction ${Math.round(h.wd||0)} degrees`);
    b.title = `${hr}:00 Â· Wind ${Math.round(h.ws||0)} kts Â· Gust ${Math.round(h.g||0)} kts Â· Dir ${Math.round(h.wd||0)}Â° Â· Code ${h.code}`;
    b.addEventListener("keydown", (event)=>{
      if(event.key === "Enter" || event.key === " "){
        event.preventDefault();
        alert(`${disp}\nWind: ${Math.round(h.ws||0)} kts\nGust: ${Math.round(h.g||0)} kts\nWaves: ${waveTxt}\nTemp: ${tempTxt}\nRain: ${rainTxt}\nDir: ${Math.round(h.wd||0)}Â° (${degToCardinal(h.wd||0)})`);
      }
    });
    barsRow.appendChild(b);
  });

  const best = bestWindow(day);
  el("bestWindow").textContent = `Best sailing window: ${best.label}`;
  el("bestDetail").textContent = best.detail;

  el("timelineNote").textContent = `Bars scaled by wind speed Â· Arrow = wind direction`;
}

function bestWindow(day){
  const slots=day.hours.slice(0,16);
  let goodCount=0;
  slots.forEach(h=>{ if(h.ws>=9 && h.ws<=18) goodCount++; });
  const label = `8amâ€“8pm (${goodCount} hours of Good or better conditions)`;
  const detail = `Becoming sunny. Sea breeze building afternoon, easing evening.`;
  return {label,detail};
}

function legendConfig(layer){
  if(layer==="wind") return {title:"Wind speed (kts)", min:0, max:30};
  if(layer==="gust") return {title:"Gusts (kts)", min:0, max:40};
  if(layer==="rain") return {title:"Rain (mm/hr)", min:0, max:6};
  if(layer==="waves") return {title:"Waves (m)", min:0, max:2};
  return {title:"",min:0,max:1};
}

function renderLegend(){
  const cfg=legendConfig(ACTIVE_LAYER);
  el("legendTitle").textContent=cfg.title;
  el("legendMin").textContent=cfg.min;
  el("legendMax").textContent=cfg.max;

  const scale=el("legendScale");scale.innerHTML="";
  for(let i=0;i<10;i++){
    const s=document.createElement("span");
    s.style.background = `rgba(37,99,235,${0.08 + i*0.07})`;
    scale.appendChild(s);
  }
}

function renderFooter(day){
  const locationName = USING_CUSTOM_PIN ? "Custom map pin" : SPOTS[ACTIVE_SPOT].name;
  el("footerLeft").textContent = `Showing: ${day.label} Â· ${locationName}`;
}

function initMap(){
  if(MAP) return;

  const s = SPOTS[ACTIVE_SPOT];
  MAP = L.map("wxMap", {zoomControl:true}).setView([s.lat, s.lon], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(MAP);

  MARKER = L.marker([s.lat, s.lon]).addTo(MAP);

  MAP.on("click", (e)=>{
    const {lat,lng}=e.latlng;
    MARKER.setLatLng([lat,lng]);
    USING_CUSTOM_PIN = true;
    CUSTOM_PIN = {lat, lon: lng};
    ACTIVE_DAY = 0;
    loadAndRender();
  });

  document.querySelectorAll(".layerBtns button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".layerBtns button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      ACTIVE_LAYER = btn.dataset.layer;
      renderLegend();
      updateMarkerPopup();
    });
  });
}

function updateMarkerPopup(){
  if(!MAP || !MARKER || !FORECAST.length) return;
  const day=FORECAST[ACTIVE_DAY];
  if(!day || !day.hours || !day.hours.length) return;
  const h=day.hours[0];
  const cfg=legendConfig(ACTIVE_LAYER);

  let val="â€”";
  if(ACTIVE_LAYER==="wind") val = `${Math.round(h.ws||0)} kts`;
  if(ACTIVE_LAYER==="gust") val = `${Math.round(h.g||0)} kts`;
  if(ACTIVE_LAYER==="rain") val = `${(h.pr!=null? (Math.round(h.pr*10)/10):0)} mm`;
  if(ACTIVE_LAYER==="waves") val = `${(h.wv!=null? (Math.round(h.wv*10)/10).toFixed(1):"â€”")} m`;

  MARKER.bindPopup(
    `<b>${USING_CUSTOM_PIN ? "Custom map pin" : SPOTS[ACTIVE_SPOT].name}</b><br>${cfg.title}: <b>${val}</b><br>Dir: ${Math.round(h.wd||0)}Â° (${degToCardinal(h.wd||0)})`
  );
}

async function loadLiveForecast(lat, lon) {
  const res = await fetch(`/api/forecast?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
  const text = await res.text();
  if(!res.ok) throw new Error(`API ${res.status}: ${text.slice(0,200)}`);
  const data = JSON.parse(text);

  if(!data || !data.hourly || !Array.isArray(data.hourly.time)) {
    throw new Error("Malformed /api/forecast response (missing hourly.time)");
  }

  const days={};
  data.hourly.time.forEach((time,i)=>{
    const date=time.slice(0,10), hour=parseInt(time.slice(11,13),10);
    if(!days[date])days[date]={date,hours:[]};
    if(hour>=5&&hour<=22){
      days[date].hours.push({
        h:hour,
        t:Math.round(data.hourly.temperature_2m?.[i] ?? 0),
        ws:Math.round(data.hourly.wind_speed_10m?.[i] ?? 0),
        wd:Math.round(data.hourly.wind_direction_10m?.[i] ?? 0),
        g:Math.round(data.hourly.wind_gusts_10m?.[i] ?? 0),
        pr:(data.hourly.precipitation?.[i] ?? 0),
        cc:(data.hourly.cloud_cover?.[i] ?? 0),
        code:(data.hourly.weathercode?.[i] ?? 0),
        wv:(data.hourly.wave_height?.[i] ?? null),
        wp:(data.hourly.wave_period?.[i] ?? null),
        wvd:(data.hourly.wave_direction?.[i] ?? null)
      });
    }
  });

  if(data.daily && Array.isArray(data.daily.time)){
    data.daily.time.forEach((d,di)=>{
      if(!days[d]) return;
      days[d].tmax = data.daily.temperature_2m_max?.[di] ?? null;
      days[d].tmin = data.daily.temperature_2m_min?.[di] ?? null;
      days[d].rainSum = data.daily.precipitation_sum?.[di] ?? null;
    });
  }

  const dayKeys = Object.keys(days).sort();          // âœ… chronological by YYYY-MM-DD
const arr = dayKeys.slice(0, 7).map(k => days[k]); // âœ… next 7 days deterministically

arr.forEach((d,i)=>{
  d.label = labelForDay(d.date, i);

  d.hours.sort((a,b)=>a.h-b.h);
  d.hours = d.hours.filter(h=>h.h>=5 && h.h<=20);

  // if the day became empty after filtering, keep it but with empty hours
  if(d.hours.length>16) d.hours = d.hours.slice(0,16);
});

return arr;

}

async function loadAndRender(){
  initMap();
  showStatus("");

  const s=SPOTS[ACTIVE_SPOT];
  const point = USING_CUSTOM_PIN && CUSTOM_PIN ? CUSTOM_PIN : {lat: s.lat, lon: s.lon};
  MAP.setView([point.lat, point.lon], 10);
  MARKER.setLatLng([point.lat, point.lon]);
  try {
    const arr = await loadLiveForecast(point.lat, point.lon);
    FORECAST = arr;
    if(!FORECAST.length){
      showStatus("No forecast data returned for this location yet. Please try another spot.");
      renderAll();
      return;
    }
    ACTIVE_DAY = clamp(ACTIVE_DAY,0,FORECAST.length-1);
    renderAll();
  } catch (err) {
    console.error(err);
    FORECAST = [];
    showStatus("Unable to load forecast data right now. Please retry in a moment.");
    renderAll();
  }
}

function renderAll(){
  renderSpotPills();
  renderDayTabs();
  const day=FORECAST[ACTIVE_DAY];
  if(!day){
    el("heroDate").textContent = "No forecast available";
    el("ratingLabel").textContent = "â€”";
    el("ratingSubtitle").textContent = "Forecast data is currently unavailable.";
    el("mWind").textContent = "â€”";
    el("mWindCard").textContent = "â€”";
    el("mGust").textContent = "â€”";
    el("mWave").textContent = "â€”";
    el("mPeriod").textContent = "â€”";
    el("mDirDeg").textContent = "â€”";
    el("mDirCard").textContent = "â€”";
    el("mTmax").textContent = "â€”";
    el("mTmin").textContent = "â€”";
    el("mTempNote").textContent = "â€”";
    el("hourLbls").innerHTML = "";
    el("barsRow").innerHTML = "";
    el("timelineNote").textContent = "No hourly data";
    el("bestWindow").textContent = "Best sailing window: â€”";
    el("bestDetail").textContent = "â€”";
    el("footerLeft").textContent = "Showing: â€”";
    renderLegend();
    return;
  }
  renderHero(day);
  renderTimeline(day);
  renderLegend();
  renderFooter(day);
  updateMarkerPopup();
}

document.getElementById("btnMapPin").addEventListener("click", ()=>{
  alert("Map pin mode: click the map to move the marker and load forecast for that pin.");
});

renderSpotPills();
initMap();
renderLegend();
loadAndRender();
</script>
</body>
</html>
