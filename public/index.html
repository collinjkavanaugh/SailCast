<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SailCast — Port Phillip Bay</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#f4f6f8; color:#1f2937; }
.header { padding:16px 20px; background:white; border-bottom:1px solid #e5e7eb; }
.container { max-width:1100px; margin:0 auto; padding:20px; }
.card { background:white; border-radius:12px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,0.06); margin-bottom:20px; }
.great { color:#16a34a; font-weight:700; font-size:28px; }
.row { display:flex; gap:40px; flex-wrap:wrap; }
.metric { font-size:20px; font-weight:600; }
.small { font-size:14px; color:#6b7280; }
.timeline { display:flex; gap:6px; align-items:flex-end; height:80px; margin-top:10px; }
.bar { width:20px; border-radius:4px 4px 0 0; }
.mapwrap { margin-top:20px; }
#map { height:400px; border-radius:12px; }
.tabs { display:flex; gap:10px; margin-bottom:10px; }
.tab { padding:6px 10px; background:#e5e7eb; border-radius:6px; cursor:pointer; font-size:14px; }
.tab.active { background:#1f2937; color:white; }
.footer { font-size:12px; color:#6b7280; margin-top:10px; }
</style>
</head>
<body>

<div class="header">
  <strong>SailCast</strong>
</div>

<div class="container">

  <div class="card">
    <div class="small">Sailing Conditions</div>
    <div id="rating" class="great">Loading...</div>
    <div id="summary" class="small"></div>

    <div class="row" style="margin-top:20px;">
      <div>
        <div class="small">Wind</div>
        <div id="windNow" class="metric"></div>
        <div id="gustNow" class="small"></div>
      </div>

      <div>
        <div class="small">Waves</div>
        <div id="waveNow" class="metric"></div>
      </div>

      <div>
        <div class="small">Direction</div>
        <div id="dirNow" class="metric"></div>
      </div>

      <div>
        <div class="small">Temperature</div>
        <div id="tempNow" class="metric"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="small">Conditions Timeline</div>
    <div id="timeline" class="timeline"></div>
  </div>

  <div class="card mapwrap">
    <div class="small">Wind & Weather Map</div>
    <div id="map"></div>
    <div class="footer" id="sourceLine"></div>
  </div>

</div>

<script>
function degToCard(deg){
  const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[Math.round(deg/22.5)%16];
}

function sailingRating(wind, gust, wave){
  if (wind>=8 && wind<=16 && gust<=22 && wave<=0.6) return "GREAT";
  if (wind>=6 && wind<=20) return "GOOD";
  return "POOR";
}

async function loadForecast(){
  const lat=-37.8676, lon=144.9741;

  const res=await fetch(`/api/forecast?lat=${lat}&lon=${lon}`);
  const data=await res.json();

  const h=data.hourly;

  const wind=h.wind_speed_10m[0];
  const gust=h.wind_gusts_10m[0];
  const dir=h.wind_direction_10m[0];
  const wave=h.wave_height?.[0] ?? 0;
  const temp=h.temperature_2m?.[0] ?? 0;

  document.getElementById("windNow").innerText=wind+" kts";
  document.getElementById("gustNow").innerText=gust+" kts gusts";
  document.getElementById("dirNow").innerText=degToCard(dir)+" ("+dir+"°)";
  document.getElementById("waveNow").innerText=wave+" m";
  document.getElementById("tempNow").innerText=temp+"°C";

  const rating=sailingRating(wind,gust,wave);
  document.getElementById("rating").innerText=rating;
  document.getElementById("summary").innerText=
    rating==="GREAT"?
    "Clean steady wind, manageable gusts and small chop.":
    rating==="GOOD"?
    "Sailable but conditions may be variable.":
    "Not ideal sailing conditions.";

  const timeline=document.getElementById("timeline");
  timeline.innerHTML="";
  for(let i=0;i<16;i++){
    const w=h.wind_speed_10m[i];
    const bar=document.createElement("div");
    bar.className="bar";
    bar.style.height=(w*4)+"px";
    bar.style.background=
      w>=8&&w<=16?"#16a34a":
      w>=6?"#f59e0b":"#a855f7";
    timeline.appendChild(bar);
  }

  const map=L.map('map').setView([lat,lon],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap contributors'
  }).addTo(map);

  L.marker([lat,lon]).addTo(map);

  document.getElementById("sourceLine").innerText=
    "Live data via /api/forecast • Updated "+
    new Date().toLocaleString("en-AU",{timeZone:"Australia/Melbourne"});
}

loadForecast();
</script>

</body>
</html>
