<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SailCast — Port Phillip Bay</title>

  <!-- Leaflet (map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Chart.js (graphs) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --bg:#0b1020; --card:#111a33; --muted:#97a2c5; --text:#e9eeff; --line:#223058; --accent:#7aa2ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .app { display:grid; grid-template-columns: 440px 1fr; height:100vh; }
    .panel { padding:18px; border-right:1px solid var(--line); overflow:auto; }
    .mapwrap { position:relative; }
    #map { height:100vh; width:100%; }

    h1 { margin:0 0 6px 0; font-size:20px; letter-spacing:0.2px; }
    .sub { color:var(--muted); font-size:13px; margin-bottom:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { color:var(--muted); font-size:12px; }
    input, select, button {
      background:#0f1730; color:var(--text);
      border:1px solid var(--line); border-radius:10px;
      padding:10px 12px; font-size:14px;
    }
    button { cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin-top:12px; }
    .kpis { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kpi { padding:10px; border:1px solid var(--line); border-radius:12px; background:#0f1730; }
    .kpi .k { color:var(--muted); font-size:12px; }
    .kpi .v { font-size:18px; margin-top:4px; }
    .err { color:#ff8585; font-size:13px; white-space:pre-wrap; }
    .ok { color:var(--muted); font-size:13px; }

    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid var(--line); padding:8px 6px; font-size:12px; text-align:left; }
    th { color:var(--muted); font-weight:600; }

    .pill {
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:#0f1730;
      padding:8px 10px; border-radius:999px; font-size:12px; color:var(--muted);
    }

    .maphint {
      position:absolute; top:14px; left:14px;
      background:rgba(15,23,48,0.92);
      border:1px solid rgba(34,48,88,0.9);
      border-radius:12px; padding:10px 12px;
      color:var(--muted); font-size:12px;
      max-width: 360px;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <h1>SailCast</h1>
      <div class="sub">Click the map to set a location. Data served by <span class="pill">/api/forecast</span></div>

      <div class="row">
        <div class="field">
          <label>Latitude</label>
          <input id="lat" type="number" step="0.0001" value="-37.8676">
        </div>
        <div class="field">
          <label>Longitude</label>
          <input id="lon" type="number" step="0.0001" value="144.9741">
        </div>
        <div class="field">
          <label>Hours</label>
          <select id="hours">
            <option value="24">24</option>
            <option value="48" selected>48</option>
            <option value="72">72</option>
            <option value="120">120</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="load">Load</button>
        </div>
      </div>

      <div class="card">
        <div id="status" class="ok">Ready.</div>
        <div id="error" class="err"></div>
      </div>

      <div class="card">
        <div class="kpis">
          <div class="kpi">
            <div class="k">Wind (now)</div>
            <div class="v" id="kpiWind">—</div>
          </div>
          <div class="kpi">
            <div class="k">Gust (now)</div>
            <div class="v" id="kpiGust">—</div>
          </div>
          <div class="kpi">
            <div class="k">Direction (now)</div>
            <div class="v" id="kpiDir">—</div>
          </div>
          <div class="kpi">
            <div class="k">Rain (now)</div>
            <div class="v" id="kpiRain">—</div>
          </div>
        </div>
        <div style="margin-top:10px;" class="ok" id="meta">—</div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div>
            <div style="font-weight:600;">48h Wind & Gust</div>
            <div class="ok">m/s (your current API). If you want knots, we’ll normalize in the API next.</div>
          </div>
        </div>
        <canvas id="chart" height="140" style="margin-top:10px;"></canvas>
      </div>

      <div class="card">
        <div style="font-weight:600; margin-bottom:8px;">Hourly Table</div>
        <div style="overflow:auto; max-height: 300px;">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Wind</th>
                <th>Gust</th>
                <th>Dir</th>
                <th>Rain</th>
                <th>Cloud</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </aside>

    <main class="mapwrap">
      <div id="map"></div>
      <div class="maphint">
        <div style="color:#e9eeff; font-weight:600; margin-bottom:4px;">Map</div>
        Click anywhere to set lat/lon and load the forecast. This is the baseline “Surfline-style” interaction: map + summary + trend.
      </div>
    </main>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // Map
  const map = L.map('map', { zoomControl: true }).setView([-37.86, 144.90], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = L.marker([-37.8676, 144.9741]).addTo(map);

  map.on('click', (e) => {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    $("lat").value = lat.toFixed(4);
    $("lon").value = lon.toFixed(4);
    marker.setLatLng([lat, lon]);
    loadForecast();
  });

  // Chart
  let chart;
  function ensureChart(labels, wind, gust) {
    const ctx = $("chart");
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Wind (m/s)', data: wind, tension: 0.2 },
          { label: 'Gust (m/s)', data: gust, tension: 0.2 }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#e9eeff' } }
        },
        scales: {
          x: { ticks: { color: '#97a2c5', maxTicksLimit: 6 }, grid: { color: '#223058' } },
          y: { ticks: { color: '#97a2c5' }, grid: { color: '#223058' } }
        }
      }
    });
  }

  function compass(deg) {
    if (deg === null || deg === undefined || Number.isNaN(deg)) return "—";
    const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
    const idx = Math.round(((deg % 360) / 22.5)) % 16;
    return `${dirs[idx]} (${Math.round(deg)}°)`;
  }

  function safeArr(a) { return Array.isArray(a) ? a : []; }

  async function loadForecast() {
    $("error").textContent = "";
    $("status").textContent = "Loading…";
    $("load").disabled = true;

    const lat = Number($("lat").value);
    const lon = Number($("lon").value);
    const hours = Number($("hours").value);

    try {
      const url = `/api/forecast?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url);
      const text = await res.text();

      if (!res.ok) {
        $("error").textContent = `HTTP ${res.status} ${res.statusText}\n\n${text}`;
        $("status").textContent = "";
        return;
      }

      const data = JSON.parse(text);

      // Your current API shape: data.hourly = { time:[], wind_speed_10m:[], ... }
      const h = data.hourly || {};
      const times = safeArr(h.time).slice(0, hours);
      const wind = safeArr(h.wind_speed_10m).slice(0, hours);
      const gust = safeArr(h.wind_gusts_10m).slice(0, hours);
      const dir  = safeArr(h.wind_direction_10m).slice(0, hours);
      const rain = safeArr(h.precipitation).slice(0, hours);
      const cloud = safeArr(h.cloud_cover).slice(0, hours);

      // KPIs: “now” = first hour returned
      $("kpiWind").textContent = (wind[0] ?? "—") + (wind[0] !== undefined ? " m/s" : "");
      $("kpiGust").textContent = (gust[0] ?? "—") + (gust[0] !== undefined ? " m/s" : "");
      $("kpiDir").textContent = compass(dir[0]);
      $("kpiRain").textContent = (rain[0] ?? "—") + (rain[0] !== undefined ? " mm" : "");

      const meta = data.meta || {};
      $("meta").textContent = `Updated: ${meta.generated_at || "—"} | TZ: ${meta.timezone || "—"} | Source: ${(meta.source || []).join(", ") || "—"}`;
      $("status").textContent = "Loaded.";

      // Chart labels: show hour only to keep it readable
      const labels = times.map(t => {
        // t in format "YYYY-MM-DDTHH:00"
        const m = String(t).match(/T(\d\d):/);
        return m ? m[1] + ":00" : t;
      });
      ensureChart(labels, wind, gust);

      // Table
      const tbody = $("tbody");
      tbody.innerHTML = "";
      for (let i = 0; i < times.length; i++) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${times[i] ?? ""}</td>
          <td>${wind[i] ?? ""}</td>
          <td>${gust[i] ?? ""}</td>
          <td>${dir[i] ?? ""}</td>
          <td>${rain[i] ?? ""}</td>
          <td>${cloud[i] ?? ""}</td>
        `;
        tbody.appendChild(tr);
      }

    } catch (e) {
      $("error").textContent = e?.message || String(e);
      $("status").textContent = "";
    } finally {
      $("load").disabled = false;
    }
  }

  $("load").addEventListener("click", loadForecast);

  // Initial load
  loadForecast();
</script>
</body>
</html>
