<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SailCast ‚Äì Port Phillip Bay</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}body{font-family:'DM Sans',sans-serif;background:#f5f6f8;color:#1a2332;min-height:100vh}.topbar{background:#1a2332;color:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;flex-wrap:wrap;gap:8px}.topbar-left{display:flex;align-items:center;gap:10px}.topbar-logo{font-family:'Space Mono',monospace;font-size:18px;font-weight:700;letter-spacing:-0.3px}.topbar-divider{width:1px;height:18px;background:rgba(255,255,255,0.15)}.topbar-loc{font-size:13px;color:rgba(255,255,255,0.7)}.skill-row{display:flex;gap:3px;background:rgba(255,255,255,0.08);border-radius:8px;padding:3px}.skill-btn{padding:5px 12px;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;color:rgba(255,255,255,0.5);background:transparent;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}.skill-btn.active{background:rgba(255,255,255,0.15);color:#fff}.skill-btn:hover{color:#fff}.container{max-width:960px;margin:0 auto;padding:20px 16px 50px}.zone-bar{display:flex;gap:6px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px}.zone-btn{padding:7px 16px;border:1px solid #dde0e6;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;background:#fff;color:#5a6577;white-space:nowrap;font-family:'DM Sans',sans-serif;transition:all .15s}.zone-btn.active{background:#1a2332;color:#fff;border-color:#1a2332}.zone-btn:hover{border-color:#1a2332}.current{background:#fff;border-radius:12px;border:1px solid #e8eaee;margin-bottom:20px;overflow:hidden}.current-header{padding:18px 22px 0;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px}.current-title{font-size:13px;color:#7a8599;text-transform:uppercase;letter-spacing:.8px;font-weight:600}.current-time{font-size:12px;color:#a0a8b8}.rating-row{display:flex;align-items:center;gap:14px;padding:10px 22px 6px}.rating-label{font-size:28px;font-weight:800;letter-spacing:-.5px}.rating-dots{display:flex;gap:4px}.rating-dot{width:32px;height:11px;border-radius:3px}.rating-desc{font-size:13px;color:#5a6577;padding:0 22px 16px;line-height:1.5}.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1px;background:#e8eaee;border-top:1px solid #e8eaee}.card{background:#fff;padding:16px 20px}.card-label{font-size:10px;color:#7a8599;text-transform:uppercase;letter-spacing:.8px;font-weight:600;margin-bottom:8px}.card-main{font-size:24px;font-weight:700;line-height:1.2}.card-main span{font-size:14px;font-weight:500;color:#7a8599}.card-sub{font-size:12px;color:#7a8599;margin-top:4px}.compass{width:64px;height:64px;border-radius:50%;border:1.5px solid #dde0e6;position:relative;margin:4px 0;flex-shrink:0;aspect-ratio:1}.compass-label{position:absolute;font-size:8px;color:#a0a8b8;font-weight:600}.compass-arrow{position:absolute;top:50%;left:50%;width:2px;height:24px;background:#1a2332;border-radius:1px;transform-origin:bottom center}.forecast-strip{background:#fff;border-radius:12px;border:1px solid #e8eaee;margin-bottom:20px;overflow:hidden}.day-tabs{display:flex;overflow-x:auto;border-bottom:1px solid #e8eaee;padding:0 12px}.day-tab{padding:12px 14px;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:#7a8599;white-space:nowrap;transition:all .15s;font-family:'DM Sans',sans-serif;background:none;border-top:none;border-left:none;border-right:none}.day-tab.active{color:#1a2332;border-bottom-color:#1a2332}.day-tab:hover{color:#1a2332}.day-tab-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px;vertical-align:middle}.timeline-section{padding:16px 22px}.tl-label-row{display:flex;justify-content:space-between;margin-bottom:6px;flex-wrap:wrap;gap:4px}.tl-label{font-size:10px;color:#7a8599;text-transform:uppercase;letter-spacing:.6px;font-weight:600}.tl-bar{display:none}.tl-seg{display:none}.tl-seg:hover{opacity:.8}.tl-hours{display:flex;justify-content:space-between}.tl-hour{font-size:10px;color:#a0a8b8;font-weight:500}.tl-tip{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1a2332;color:#fff;padding:8px 12px;border-radius:8px;font-size:11px;white-space:nowrap;z-index:10;pointer-events:none;min-width:160px;line-height:1.5}.tl-tip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1a2332}.tl-seg:hover .tl-tip{display:block}.tl-summary{font-size:13px;color:#5a6577;padding:8px 0 0;line-height:1.5}.section-title{font-size:12px;font-weight:700;color:#7a8599;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;padding-top:8px}table{width:100%;min-width:600px;border-collapse:collapse;font-size:12px}th{padding:8px 6px;font-size:9px;color:#7a8599;text-transform:uppercase;letter-spacing:.6px;font-weight:600;text-align:left;border-bottom:1px solid #e8eaee}td{padding:8px 6px;border-bottom:1px solid #f0f1f3}tr:last-child td{border-bottom:none}.mini{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;font-family:'Space Mono',monospace}.wbar{display:inline-block;width:32px;height:4px;background:#e8eaee;border-radius:2px;overflow:hidden;vertical-align:middle;margin-right:5px}.wbar-in{height:100%;border-radius:2px}.dim{color:#7a8599}.warn{color:#e74c3c}.legend{background:#fff;border-radius:12px;border:1px solid #e8eaee;padding:18px 22px;margin-bottom:16px}.legend-title{font-size:12px;font-weight:700;color:#7a8599;text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px}.legend-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}.legend-card{text-align:center;padding:10px 6px;border-radius:8px;background:#fafbfc;border:1px solid #eef0f3}.legend-card-label{font-size:13px;font-weight:700;margin-bottom:4px}.legend-card-score{font-size:10px;color:#7a8599;font-family:'Space Mono',monospace;margin-bottom:6px}.legend-card-dots{display:flex;gap:3px;justify-content:center;margin-bottom:6px}.legend-card-dot{width:14px;height:6px;border-radius:2px}.legend-card-desc{font-size:10px;color:#7a8599;line-height:1.4}.disclaimer{background:#fff;border-radius:12px;border:1px solid #e8eaee;padding:16px 20px;font-size:11px;color:#7a8599;line-height:1.6}.disclaimer strong{color:#5a6577}.src{margin-top:4px;font-size:10px;color:#a0a8b8}@media(max-width:700px){.cards{grid-template-columns:repeat(2,1fr)}.legend-grid{grid-template-columns:repeat(2,1fr)}.legend-grid .legend-card:last-child{grid-column:span 2}}

.tl-unified-wrap{display:flex;gap:2px;align-items:flex-end;margin-bottom:6px}
.tl-unified:hover .tl-ubar{opacity:1!important;transform:scaleY(1.12) scaleX(1.08);z-index:3}
.tl-unified:hover .tl-kt{color:#1a2332!important;font-weight:700!important;font-size:9px!important}
.tl-unified:hover .tl-tip{display:block}
.tl-ubar{border-radius:4px 4px 2px 2px;position:relative;transition:all .15s ease;transform-origin:bottom center;min-height:8px;width:100%}
.tl-kt{position:absolute;top:-15px;left:50%;transform:translateX(-50%);font-size:8px;color:#a0a8b8;font-weight:400;font-family:'Space Mono',monospace;white-space:nowrap;transition:all .12s}
.tl-kt-sel{color:#1a2332!important;font-weight:700!important;font-size:9px!important}
.tl-unified:hover .tl-kt{color:#1a2332;font-weight:700;font-size:9px}

.tl-bar-icons{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);line-height:1;opacity:0.55;pointer-events:none;white-space:nowrap;color:#1a2332;display:flex;gap:1px;align-items:center}
.tl-unified:hover .tl-bar-icons{opacity:0.85}


.map-toggle{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border:1px solid #dde0e6;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;background:#fff;color:#5a6577;font-family:'DM Sans',sans-serif;transition:all .15s;margin-left:6px}
.map-toggle.active{background:#1a2332;color:#fff;border-color:#1a2332}
.map-toggle:hover{border-color:#1a2332}
.map-wrap{display:none;background:#fff;border-radius:12px;border:1px solid #e8eaee;margin-bottom:20px;overflow:hidden}
.map-wrap.open{display:block}
.map-container{height:340px;width:100%;position:relative}
.map-info{padding:12px 18px;font-size:12px;color:#5a6577;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;border-top:1px solid #e8eaee}
.map-coords{font-family:'Space Mono',monospace;font-size:11px;color:#7a8599}
.map-loc-name{font-weight:600;color:#1a2332;font-size:13px}
.map-hint{font-size:11px;color:#a0a8b8;font-style:italic}
.custom-marker{background:#7c3aed;border:2px solid #fff;border-radius:50%;width:14px;height:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.marina-marker{background:#1db954;border:2px solid #fff;border-radius:50%;width:10px;height:10px;box-shadow:0 1px 4px rgba(0,0,0,0.2)}

.tl-graph-wrap{display:flex;gap:0;align-items:stretch;margin-bottom:6px}
.tl-yaxis{width:30px;position:relative;flex-shrink:0;height:180px;margin-top:15px}
.tl-ytick{position:absolute;right:6px;font-size:8px;color:#a0a8b8;font-family:'Space Mono',monospace;transform:translateY(50%);line-height:1}
.tl-ylabel{position:absolute;top:-14px;right:6px;font-size:7px;color:#a0a8b8;text-transform:uppercase;letter-spacing:.5px;font-family:'Space Mono',monospace}
.tl-graph-area{flex:1;position:relative;min-width:0}
.tl-gridlines{position:absolute;top:15px;left:0;right:0;bottom:0;pointer-events:none;z-index:0}
.tl-gridline{position:absolute;left:0;right:0;height:1px;background:rgba(0,0,0,0.06)}
.tl-unified-wrap{display:flex;gap:2px;align-items:flex-end;position:relative;z-index:1}

.tl-ideal-band{position:absolute;left:0;right:0;background:rgba(29,185,84,0.06);border-top:1px dashed rgba(29,185,84,0.25);border-bottom:1px dashed rgba(29,185,84,0.25);pointer-events:none;z-index:0}

.map-weather-section{margin-bottom:16px}
.wx-map-wrap{border-radius:8px;overflow:hidden;border:1px solid #e8eaee;position:relative}
.wx-map{height:420px;width:100%;background:#e8edf2}
.wx-map-legend{position:absolute;bottom:12px;left:12px;background:rgba(255,255,255,0.92);border-radius:8px;padding:8px 12px;font-size:10px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.1);backdrop-filter:blur(4px)}
.wx-map-legend-title{font-weight:700;color:#1a2332;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;font-size:9px}
.wx-map-legend-bar{display:flex;height:8px;border-radius:2px;overflow:hidden;margin-bottom:3px;width:140px}
.wx-map-legend-labels{display:flex;justify-content:space-between;font-size:8px;color:#7a8599;font-family:"Space Mono",monospace;width:140px}
.map-info-bar{padding:8px 14px;font-size:10px;color:#a0a8b8;background:#fafbfc;border:1px solid #e8eaee;border-top:none;border-radius:0 0 8px 8px}
.map-info-bar a:hover{text-decoration:underline}
.map-info-bar a{color:#1db954;text-decoration:none;font-weight:500}
.map-layer-btns{display:flex;gap:3px}
.map-layer-btn{padding:4px 10px;border:1px solid #dde0e6;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;background:#fff;color:#7a8599;font-family:'DM Sans',sans-serif;transition:all .12s;text-transform:uppercase;letter-spacing:.3px}
.map-layer-btn.active{background:#1a2332;color:#fff;border-color:#1a2332}
.map-layer-btn:hover{border-color:#1a2332}

</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<div class="topbar"><div class="topbar-left"><span style="font-size:18px">‚õµ</span><span class="topbar-logo">SailCast</span><span class="topbar-divider"></span><span class="topbar-loc">Port Phillip Bay</span></div><div class="skill-row" id="skill-row"></div></div>
<div class="container">
<div style="display:flex;align-items:center;gap:0;margin-bottom:20px;overflow-x:auto;padding-bottom:4px">
<div class="zone-bar" id="zone-bar" style="margin-bottom:0"></div>
<button class="map-toggle" id="map-toggle" onclick="toggleMap()">üìç Map</button>
</div>
<div class="map-wrap" id="map-wrap">
<div class="map-container" id="map"></div>
<div class="map-info">
<div><span class="map-loc-name" id="map-loc-name">Click the map to set a custom location</span><br><span class="map-coords" id="map-coords"></span></div>
<div><span class="map-hint">Click any point on Port Phillip Bay ¬∑ Marinas shown as green dots</span></div>
</div>
</div>
<div class="current" id="current-card"></div>
<div class="forecast-strip"><div class="day-tabs" id="day-tabs"></div><div class="timeline-section" id="timeline-section"></div><div class="map-weather-section">
      <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
        <span>Wind & Weather Map</span>
        
      </div>
      
    </div>
    </div>
<div class="legend" id="legend"></div>
<div class="disclaimer"><strong>‚ö†Ô∏è Disclaimer:</strong> Forecasts are estimates, not guarantees. Conditions vary within zones. Wind gusts can be 40% stronger than forecast averages, and stronger still in squalls and thunderstorms (BOM). Always rely on local judgment and safe sailing practices.<br><span class="src">Data: Bureau of Meteorology (bom.gov.au) detailed 3-hourly forecast, interpolated to hourly ¬∑ Updated 10 Feb 2026 ¬∑ Wave data from BOM Port Phillip marine forecast</span></div>
</div>
<script>
const ZONES=[{id:"rmys",name:"RMYS St Kilda Marina",note:"Royal Melbourne Yacht Squadron, N shore"},{id:"savages",name:"Savages Wharf, Williamstown",note:"Full-service marina, NW shore"},{id:"syc",name:"Sandringham Yacht Club",note:"356-berth marina, E shore"},{id:"rbyc",name:"Royal Brighton Yacht Club",note:"241-berth marina, N shore"},{id:"bys",name:"Blairgowrie Yacht Squadron",note:"S bay near The Heads, exposed"}];
const SKILLS={beginner:{label:"Beginner",windIdealMin:3,windIdealMax:8,gustIdealMax:10,waveIdealMax:0.2,windAbsMax:12,gustAbsMax:14,waveAbsMax:0.4},intermediate:{label:"Intermediate",windIdealMin:5,windIdealMax:15,gustIdealMax:20,waveIdealMax:0.5,windAbsMax:20,gustAbsMax:25,waveAbsMax:0.8},advanced:{label:"Advanced",windIdealMin:8,windIdealMax:25,gustIdealMax:30,waveIdealMax:1.2,windAbsMax:32,gustAbsMax:40,waveAbsMax:2.0}};
const ZONE_DIR={
rmys:{ideal:170,bad:340,desc:"S/SSE best (onshore sea breeze). N/NNW worst (offshore, gusty)."},
savages:{ideal:200,bad:20,desc:"SSW/SW best (onshore). N/NNE worst (offshore across bay)."},
syc:{ideal:240,bad:60,desc:"WSW/SW best (onshore). ENE worst (offshore)."},
rbyc:{ideal:180,bad:0,desc:"S best (onshore). N worst (offshore)."},
bys:{ideal:0,bad:200,desc:"N/NNW best (sheltered from ocean swell). SSW worst (exposed to swell)."}
};
function mh(b){return b.map(x=>({hour:x.h,temp:x.t,precip:x.pr,cloud:x.cl,windKph:x.ws,windDir:x.wd,gustKph:x.gs,waveHeight:x.wv,wavePeriod:x.wp||5,thunderstorm:x.ts||false}));}
const FORECAST=[
  {date:"2026-02-10",label:"Tue 10/2",tempMax:25,tempMin:16,precipSum:0.0,summary:"Becoming sunny. Light southerly sea breeze building to 12-13kt afternoon, easing evening. Dry.",windDesc:"SSE‚ÜíS 6‚Äì13 kts",hours:mh([{h:5,t:16,pr:0,cl:60,ws:8,wd:157,gs:10,wv:0.20,wp:5},{h:6,t:17,pr:0,cl:57,ws:9,wd:157,gs:11,wv:0.23,wp:5},{h:7,t:17,pr:0,cl:53,ws:9,wd:157,gs:12,wv:0.27,wp:5},{h:8,t:18,pr:0,cl:50,ws:10,wd:157,gs:13,wv:0.30,wp:5},{h:9,t:19,pr:0,cl:47,ws:10,wd:157,gs:13,wv:0.30,wp:5},{h:10,t:19,pr:0,cl:43,ws:11,wd:157,gs:14,wv:0.30,wp:5},{h:11,t:20,pr:0,cl:40,ws:11,wd:157,gs:14,wv:0.30,wp:5},{h:12,t:21,pr:0,cl:35,ws:14,wd:202,gs:18,wv:0.33,wp:5},{h:13,t:22,pr:0,cl:30,ws:16,wd:202,gs:22,wv:0.37,wp:5},{h:14,t:23,pr:0,cl:25,ws:19,wd:202,gs:25,wv:0.40,wp:5},{h:15,t:24,pr:0,cl:22,ws:20,wd:180,gs:27,wv:0.40,wp:5},{h:16,t:24,pr:0,cl:18,ws:21,wd:180,gs:28,wv:0.40,wp:5},{h:17,t:25,pr:0,cl:15,ws:22,wd:180,gs:29,wv:0.40,wp:5},{h:18,t:24,pr:0,cl:13,ws:23,wd:180,gs:30,wv:0.37,wp:5},{h:19,t:24,pr:0,cl:12,ws:23,wd:180,gs:31,wv:0.33,wp:5},{h:20,t:23,pr:0,cl:10,ws:24,wd:180,gs:32,wv:0.30,wp:5},{h:21,t:22,pr:0,cl:10,ws:22,wd:157,gs:29,wv:0.27,wp:5},{h:22,t:20,pr:0,cl:10,ws:19,wd:157,gs:26,wv:0.23,wp:5}])},
  {date:"2026-02-11",label:"Wed 11/2",tempMax:31,tempMin:17,precipSum:4.0,summary:"Hot. N wind AM, strong SW change PM with showers. Gusty and unsettled from midday.",windDesc:"N 6‚Äì11 kts ‚Üí SSW/WSW 17‚Äì18 kts",hours:mh([{h:5,t:18,pr:0.0,cl:10,ws:11,wd:22,gs:16,wv:0.20,wp:5},{h:6,t:20,pr:0.0,cl:12,ws:14,wd:22,gs:20,wv:0.23,wp:5},{h:7,t:21,pr:0.0,cl:13,ws:17,wd:0,gs:24,wv:0.27,wp:5},{h:8,t:23,pr:0.0,cl:15,ws:20,wd:0,gs:28,wv:0.30,wp:5},{h:9,t:25,pr:0.0,cl:17,ws:20,wd:0,gs:27,wv:0.30,wp:5},{h:10,t:28,pr:0.0,cl:18,ws:19,wd:0,gs:27,wv:0.30,wp:5},{h:11,t:30,pr:0.0,cl:20,ws:19,wd:0,gs:26,wv:0.30,wp:5},{h:12,t:30,pr:0.7,cl:33,ws:24,wd:0,gs:33,wv:0.40,wp:5},{h:13,t:31,pr:1.3,cl:47,ws:28,wd:180,gs:39,wv:0.50,wp:5,ts:true},{h:14,t:31,pr:2.0,cl:60,ws:33,wd:202,gs:46,wv:0.60,wp:5,ts:true},{h:15,t:29,pr:2.7,cl:65,ws:32,wd:225,gs:45,wv:0.67,wp:5,ts:true},{h:16,t:27,pr:3.3,cl:70,ws:32,wd:247,gs:44,wv:0.73,wp:5},{h:17,t:25,pr:4.0,cl:75,ws:31,wd:247,gs:43,wv:0.80,wp:5},{h:18,t:23,pr:3.0,cl:72,ws:31,wd:225,gs:43,wv:0.77,wp:5},{h:19,t:22,pr:2.0,cl:68,ws:31,wd:225,gs:43,wv:0.73,wp:5},{h:20,t:20,pr:1.0,cl:65,ws:31,wd:225,gs:43,wv:0.70,wp:5},{h:21,t:19,pr:0.7,cl:62,ws:31,wd:202,gs:43,wv:0.63,wp:5},{h:22,t:18,pr:0.3,cl:58,ws:31,wd:202,gs:43,wv:0.57,wp:5}])},
  {date:"2026-02-12",label:"Thu 12/2",tempMax:21,tempMin:15,precipSum:0.5,summary:"Cloudy, breezy SW/S easing through the day. Slight shower chance early. Choppy bay.",windDesc:"SW 16‚Äì17 kts ‚Üí S 10‚Äì12 kts",hours:mh([{h:5,t:15,pr:0.1,cl:80,ws:30,wd:225,gs:42,wv:0.70,wp:5},{h:6,t:15,pr:0.1,cl:80,ws:31,wd:225,gs:43,wv:0.73,wp:5},{h:7,t:16,pr:0.2,cl:80,ws:31,wd:225,gs:44,wv:0.77,wp:5},{h:8,t:16,pr:0.2,cl:80,ws:32,wd:225,gs:45,wv:0.80,wp:5},{h:9,t:17,pr:0.2,cl:77,ws:31,wd:202,gs:43,wv:0.77,wp:5},{h:10,t:17,pr:0.1,cl:73,ws:29,wd:202,gs:41,wv:0.73,wp:5},{h:11,t:18,pr:0.1,cl:70,ws:28,wd:180,gs:39,wv:0.70,wp:5},{h:12,t:19,pr:0.1,cl:67,ws:27,wd:180,gs:37,wv:0.67,wp:5},{h:13,t:19,pr:0.0,cl:63,ws:25,wd:180,gs:36,wv:0.63,wp:5},{h:14,t:20,pr:0.0,cl:60,ws:24,wd:180,gs:34,wv:0.60,wp:5},{h:15,t:20,pr:0.0,cl:57,ws:23,wd:180,gs:33,wv:0.57,wp:5},{h:16,t:21,pr:0.0,cl:53,ws:23,wd:180,gs:32,wv:0.53,wp:5},{h:17,t:21,pr:0.0,cl:50,ws:22,wd:180,gs:31,wv:0.50,wp:5},{h:18,t:20,pr:0.0,cl:47,ws:21,wd:157,gs:29,wv:0.47,wp:5},{h:19,t:19,pr:0.0,cl:43,ws:19,wd:157,gs:27,wv:0.43,wp:5},{h:20,t:18,pr:0.0,cl:40,ws:18,wd:157,gs:25,wv:0.40,wp:5},{h:21,t:17,pr:0.0,cl:38,ws:17,wd:157,gs:24,wv:0.37,wp:5},{h:22,t:17,pr:0.0,cl:37,ws:16,wd:157,gs:22,wv:0.33,wp:5}])},
  {date:"2026-02-13",label:"Fri 13/2",tempMax:23,tempMin:14,precipSum:0.0,summary:"Partly cloudy, steady S/SE breeze. Dry. Good sailing midday‚Äìlate afternoon.",windDesc:"SSE 6‚Äì14 kts, steady",hours:mh([{h:5,t:14,pr:0,cl:25,ws:12,wd:157,gs:17,wv:0.30,wp:5},{h:6,t:14,pr:0,cl:23,ws:13,wd:157,gs:19,wv:0.33,wp:5},{h:7,t:15,pr:0,cl:22,ws:15,wd:157,gs:20,wv:0.37,wp:5},{h:8,t:15,pr:0,cl:20,ws:16,wd:157,gs:22,wv:0.40,wp:5},{h:9,t:16,pr:0,cl:23,ws:18,wd:157,gs:25,wv:0.43,wp:5},{h:10,t:17,pr:0,cl:27,ws:20,wd:157,gs:27,wv:0.47,wp:5},{h:11,t:18,pr:0,cl:30,ws:22,wd:157,gs:30,wv:0.50,wp:5},{h:12,t:19,pr:0,cl:28,ws:23,wd:157,gs:32,wv:0.50,wp:5},{h:13,t:21,pr:0,cl:27,ws:25,wd:157,gs:33,wv:0.50,wp:5},{h:14,t:22,pr:0,cl:25,ws:26,wd:157,gs:35,wv:0.50,wp:5},{h:15,t:22,pr:0,cl:23,ws:25,wd:157,gs:34,wv:0.47,wp:5},{h:16,t:23,pr:0,cl:22,ws:25,wd:168,gs:34,wv:0.43,wp:5},{h:17,t:23,pr:0,cl:20,ws:24,wd:168,gs:33,wv:0.40,wp:5},{h:18,t:22,pr:0,cl:18,ws:22,wd:168,gs:30,wv:0.37,wp:5},{h:19,t:20,pr:0,cl:17,ws:20,wd:168,gs:28,wv:0.33,wp:5},{h:20,t:19,pr:0,cl:15,ws:18,wd:168,gs:25,wv:0.30,wp:5},{h:21,t:18,pr:0,cl:13,ws:16,wd:168,gs:22,wv:0.27,wp:5},{h:22,t:17,pr:0,cl:12,ws:14,wd:168,gs:20,wv:0.23,wp:5}])},
  {date:"2026-02-14",label:"Sat 14/2",tempMax:22,tempMin:14,precipSum:0.0,summary:"Sunny. Light SE breeze, flat bay. Classic summer day on Port Phillip.",windDesc:"SE 5‚Äì10 kts, light & steady",hours:mh([{h:5,t:14,pr:0,cl:10,ws:6,wd:157,gs:10,wv:0.20,wp:5},{h:6,t:14,pr:0,cl:8,ws:7,wd:157,gs:11,wv:0.20,wp:5},{h:7,t:15,pr:0,cl:7,ws:9,wd:145,gs:13,wv:0.20,wp:5},{h:8,t:15,pr:0,cl:5,ws:10,wd:145,gs:14,wv:0.20,wp:5},{h:9,t:16,pr:0,cl:5,ws:12,wd:135,gs:17,wv:0.23,wp:5},{h:10,t:18,pr:0,cl:5,ws:14,wd:135,gs:19,wv:0.27,wp:5},{h:11,t:19,pr:0,cl:5,ws:16,wd:135,gs:22,wv:0.30,wp:5},{h:12,t:20,pr:0,cl:7,ws:17,wd:135,gs:23,wv:0.30,wp:5},{h:13,t:21,pr:0,cl:8,ws:17,wd:135,gs:23,wv:0.30,wp:5},{h:14,t:22,pr:0,cl:10,ws:18,wd:145,gs:24,wv:0.30,wp:5},{h:15,t:22,pr:0,cl:10,ws:17,wd:145,gs:23,wv:0.30,wp:5},{h:16,t:22,pr:0,cl:10,ws:17,wd:157,gs:23,wv:0.30,wp:5},{h:17,t:22,pr:0,cl:10,ws:16,wd:157,gs:22,wv:0.30,wp:5},{h:18,t:21,pr:0,cl:8,ws:14,wd:157,gs:19,wv:0.27,wp:5},{h:19,t:19,pr:0,cl:7,ws:12,wd:157,gs:17,wv:0.23,wp:5},{h:20,t:18,pr:0,cl:5,ws:10,wd:157,gs:14,wv:0.20,wp:5},{h:21,t:17,pr:0,cl:5,ws:9,wd:157,gs:13,wv:0.20,wp:5},{h:22,t:16,pr:0,cl:5,ws:7,wd:157,gs:11,wv:0.20,wp:5}])},
  {date:"2026-02-15",label:"Sun 15/2",tempMax:25,tempMin:15,precipSum:0.0,summary:"Mostly sunny. Morning NW rotation to SE sea breeze. Flat bay, great PM window.",windDesc:"Variable ‚Üí SE 9‚Äì11 kts",hours:mh([{h:5,t:15,pr:0,cl:10,ws:5,wd:315,gs:8,wv:0.20,wp:5},{h:6,t:15,pr:0,cl:10,ws:7,wd:315,gs:10,wv:0.20,wp:5},{h:7,t:16,pr:0,cl:10,ws:8,wd:340,gs:12,wv:0.20,wp:5},{h:8,t:16,pr:0,cl:10,ws:10,wd:22,gs:14,wv:0.20,wp:5},{h:9,t:18,pr:0,cl:10,ws:12,wd:45,gs:17,wv:0.23,wp:5},{h:10,t:20,pr:0,cl:10,ws:14,wd:90,gs:19,wv:0.27,wp:5},{h:11,t:22,pr:0,cl:10,ws:16,wd:120,gs:22,wv:0.30,wp:5},{h:12,t:23,pr:0,cl:12,ws:17,wd:135,gs:23,wv:0.33,wp:5},{h:13,t:24,pr:0,cl:13,ws:19,wd:135,gs:25,wv:0.37,wp:5},{h:14,t:25,pr:0,cl:15,ws:20,wd:145,gs:26,wv:0.40,wp:5},{h:15,t:25,pr:0,cl:13,ws:19,wd:145,gs:25,wv:0.37,wp:5},{h:16,t:24,pr:0,cl:12,ws:19,wd:157,gs:25,wv:0.33,wp:5},{h:17,t:24,pr:0,cl:10,ws:18,wd:157,gs:24,wv:0.30,wp:5},{h:18,t:23,pr:0,cl:8,ws:16,wd:157,gs:21,wv:0.27,wp:5},{h:19,t:21,pr:0,cl:7,ws:14,wd:157,gs:19,wv:0.23,wp:5},{h:20,t:20,pr:0,cl:5,ws:12,wd:157,gs:16,wv:0.20,wp:5},{h:21,t:19,pr:0,cl:5,ws:10,wd:157,gs:14,wv:0.20,wp:5},{h:22,t:18,pr:0,cl:5,ws:8,wd:157,gs:12,wv:0.20,wp:5}])},
  {date:"2026-02-16",label:"Mon 16/2",tempMax:24,tempMin:15,precipSum:0.5,summary:"Partly cloudy. NE building, tending SE midday. Slight shower chance late.",windDesc:"NE 6‚Äì13 kts ‚Üí SE",hours:mh([{h:5,t:15,pr:0.0,cl:20,ws:6,wd:10,gs:10,wv:0.20,wp:5},{h:6,t:15,pr:0.0,cl:20,ws:8,wd:10,gs:12,wv:0.20,wp:5},{h:7,t:16,pr:0.0,cl:20,ws:10,wd:22,gs:15,wv:0.20,wp:5},{h:8,t:16,pr:0.0,cl:20,ws:12,wd:22,gs:17,wv:0.20,wp:5},{h:9,t:18,pr:0.0,cl:23,ws:15,wd:45,gs:21,wv:0.27,wp:5},{h:10,t:19,pr:0.0,cl:27,ws:17,wd:90,gs:24,wv:0.33,wp:5},{h:11,t:21,pr:0.0,cl:30,ws:20,wd:120,gs:28,wv:0.40,wp:5},{h:12,t:22,pr:0.1,cl:33,ws:21,wd:135,gs:29,wv:0.43,wp:5},{h:13,t:23,pr:0.1,cl:37,ws:23,wd:145,gs:31,wv:0.47,wp:5},{h:14,t:24,pr:0.2,cl:40,ws:24,wd:145,gs:32,wv:0.50,wp:5},{h:15,t:23,pr:0.2,cl:38,ws:23,wd:157,gs:31,wv:0.47,wp:5},{h:16,t:23,pr:0.2,cl:37,ws:21,wd:157,gs:29,wv:0.43,wp:5},{h:17,t:22,pr:0.2,cl:35,ws:20,wd:157,gs:28,wv:0.40,wp:5},{h:18,t:21,pr:0.1,cl:32,ws:18,wd:157,gs:25,wv:0.37,wp:5},{h:19,t:20,pr:0.1,cl:28,ws:16,wd:157,gs:23,wv:0.33,wp:5},{h:20,t:19,pr:0.0,cl:25,ws:14,wd:157,gs:20,wv:0.30,wp:5},{h:21,t:18,pr:0.0,cl:22,ws:12,wd:157,gs:17,wv:0.27,wp:5},{h:22,t:17,pr:0.0,cl:18,ws:10,wd:157,gs:15,wv:0.23,wp:5}])}
];
const DIRS=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
const d2c=d=>DIRS[Math.round(d/22.5)%16];
const k2kt=k=>k*0.539957;
function scoreToRating(s){if(s>=80)return{label:"Excellent",tier:5,color:"#7c3aed"};if(s>=60)return{label:"Great",tier:4,color:"#1db954"};if(s>=40)return{label:"Good",tier:3,color:"#f5a623"};if(s>=20)return{label:"Okay",tier:2,color:"#e88d1a"};return{label:"Poor",tier:1,color:"#e74c3c"};}
function ratingDots(r){return Array.from({length:5},(_,i)=>`<div class="rating-dot" style="background:${i<r.tier?r.color:'#e0e3e8'}"></div>`).join("");}
const RATING_DESC={"Poor":"Barely sailable. Wind is either too light to move or dangerously strong/gusty. Uncomfortable chop or thunderstorm risk. Stay on shore.","Okay":"You can sail, but it won't be memorable. Inconsistent wind, gusty patches, or awkward direction. Only worth it if you're keen to get out regardless.","Good":"Worth going out. Decent, usable wind with manageable gusts and waves. The baseline 'good day on the bay' for most sailors.","Great":"Rearrange your day for this. Clean, steady wind in the ideal range, light gusts, flat-to-small chop, and a favourable direction.","Excellent":"Rare. Everything lines up ‚Äî ideal wind speed, perfect direction for the zone, negligible gusts, glass-flat bay, no rain."};
function scoreHour(h,skill){const ws=k2kt(h.windKph),gs=k2kt(h.gustKph);const sk=SKILLS[skill];if(h.thunderstorm)return{score:0,rating:scoreToRating(0),ws,gs};let windBase=0;if(ws>=sk.windIdealMin&&ws<=sk.windIdealMax){const center=(sk.windIdealMin+sk.windIdealMax)/2;const halfRange=(sk.windIdealMax-sk.windIdealMin)/2;const dist=Math.abs(ws-center)/halfRange;windBase=45+(1-dist*dist)*27;}else if(ws<sk.windIdealMin){if(ws<1.5)windBase=0;else windBase=((ws-1.5)/(sk.windIdealMin-1.5))*25;}else if(ws<=sk.windAbsMax){const over=(ws-sk.windIdealMax)/(sk.windAbsMax-sk.windIdealMax);windBase=Math.max(0,40*(1-over));}else{windBase=0;}let penalty=0,bonus=0;if(gs>sk.gustAbsMax)penalty+=35;else if(gs>sk.gustIdealMax){penalty+=((gs-sk.gustIdealMax)/(sk.gustAbsMax-sk.gustIdealMax))*25;}const gustDiff=gs-ws;if(gustDiff>12)penalty+=15;else if(gustDiff>8)penalty+=10;else if(gustDiff>5)penalty+=5;if(gustDiff<3&&ws>=sk.windIdealMin)bonus+=8;else if(gustDiff<4&&ws>=sk.windIdealMin)bonus+=4;const waveOver=h.waveHeight-sk.waveIdealMax;if(h.waveHeight>sk.waveAbsMax)penalty+=30;else if(waveOver>0){const ratio=waveOver/(sk.waveAbsMax-sk.waveIdealMax);penalty+=ratio*ratio*25+ratio*5;}if(h.waveHeight<=0.15&&ws>=sk.windIdealMin)bonus+=7;else if(h.waveHeight<=0.25&&ws>=sk.windIdealMin)bonus+=4;else if(h.waveHeight<=0.35)bonus+=1;if(h.wavePeriod&&h.wavePeriod<4&&h.waveHeight>0.3)penalty+=4;const dir=h.windDir;const zd=ZONE_DIR[ZONES[currentZone].id]||ZONE_DIR.rmys;let dirDelta=Math.abs(dir-zd.ideal);if(dirDelta>180)dirDelta=360-dirDelta;if(dirDelta<=30)bonus+=3;else if(dirDelta<=60)bonus+=1;else if(dirDelta<=90){}else if(dirDelta<=120)penalty+=2;else penalty+=5;if(zd.bad){let bd=Math.abs(dir-zd.bad);if(bd>180)bd=360-bd;if(bd<=40)penalty+=3;}if(h.precip>5)penalty+=15;else if(h.precip>2)penalty+=10;else if(h.precip>0.5)penalty+=6;else if(h.precip>0)penalty+=3;if(h.precip===0)bonus+=2;if(gs>sk.gustIdealMax*1.2)windBase=Math.min(windBase,25);let score=Math.round(Math.max(0,Math.min(100,windBase+bonus-penalty)));return{score,rating:scoreToRating(score),ws,gs};}
let currentSkill="intermediate",currentDay=0,currentZone=0,selectedHour=null;
function renderAll(){selectedHour=null;renderSkills();renderZones();renderCurrent();renderDayTabs();renderTimeline();renderLegend();}
function renderSkills(){document.getElementById("skill-row").innerHTML=Object.entries(SKILLS).map(([k,v])=>`<button class="skill-btn ${currentSkill===k?"active":""}" onclick="currentSkill='${k}';renderAll()">${v.label}</button>`).join("");}
function renderZones(){document.getElementById("zone-bar").innerHTML=ZONES.map((z,i)=>`<button class="zone-btn ${currentZone===i?"active":""}" onclick="currentZone=${i};renderAll()">${z.name}</button>`).join("");}
function renderCurrent(){const day=FORECAST[currentDay];const curH=selectedHour!==null?selectedHour:(currentDay===0?Math.max(5,Math.min(22,new Date().getHours())):10);const hd=day.hours.find(h=>h.hour===curH)||day.hours[6];const s=scoreHour(hd,currentSkill);const r=s.rating;document.getElementById("current-card").innerHTML=`<div class="current-header"><div class="current-title">Sailing Conditions</div><div class="current-time">${day.label}${selectedHour!==null?" ¬∑ "+(selectedHour===0?"12am":selectedHour===12?"12pm":selectedHour>12?(selectedHour-12)+"pm":selectedHour+"am"):""} ¬∑ ${ZONES[currentZone].name} ¬∑ ${SKILLS[currentSkill].label}</div></div><div class="rating-row"><div class="rating-label" style="color:${r.color}">${r.label.toUpperCase()}</div><div class="rating-dots">${ratingDots(r)}</div></div><div class="rating-desc">${RATING_DESC[r.label]}</div><div class="cards"><div class="card"><div class="card-label">Wind</div><div class="card-main">${Math.round(s.ws)}<span>kts</span> ${d2c(hd.windDir)}</div><div class="card-sub">${Math.round(s.gs)} kts gusts</div></div><div class="card"><div class="card-label">Waves</div><div class="card-main">${hd.waveHeight.toFixed(1)}<span>m</span></div><div class="card-sub">${hd.wavePeriod}s period ¬∑ Port Phillip Bay</div></div><div class="card"><div class="card-label">Wind Direction</div><div style="display:flex;align-items:center;gap:14px"><div class="compass"><div class="compass-label" style="top:3px;left:50%;transform:translateX(-50%)">N</div><div class="compass-label" style="bottom:3px;left:50%;transform:translateX(-50%)">S</div><div class="compass-label" style="right:5px;top:50%;transform:translateY(-50%)">E</div><div class="compass-label" style="left:5px;top:50%;transform:translateY(-50%)">W</div><div class="compass-arrow" style="transform:translate(-50%,-100%) rotate(${hd.windDir}deg)"></div></div><div><div style="font-size:18px;font-weight:700">${d2c(hd.windDir)} ${hd.windDir}¬∞</div><div style="font-size:10px;color:#a0a8b8;margin-top:2px">${(ZONE_DIR[ZONES[currentZone].id]||{desc:""}).desc}</div></div></div></div><div class="card"><div class="card-label">Day Temperature</div><div class="card-main">‚òÄÔ∏è ${day.tempMax}<span>¬∞c</span>&nbsp; üåô ${day.tempMin}<span>¬∞c</span></div><div class="card-sub">${day.precipSum>0?day.precipSum.toFixed(1)+'mm rain':'No rain expected'}</div></div></div>`;}
function dayRating(i){const d=FORECAST[i];const dh=d.hours.filter(h=>h.hour>=6&&h.hour<=20);const sc=dh.map(h=>scoreHour(h,currentSkill).score);const avg=sc.length?sc.reduce((a,b)=>a+b,0)/sc.length:0;return scoreToRating(Math.round(avg));}
function renderDayTabs(){document.getElementById("day-tabs").innerHTML=FORECAST.map((d,i)=>{const dr=dayRating(i);return`<button class="day-tab ${i===currentDay?"active":""}" onclick="currentDay=${i};renderAll()">${i===0?"Today":i===1?"Tomorrow":d.label}<span class="day-tab-dot" style="background:${dr.color}"></span></button>`;}).join("");}
function renderTimeline(){const day=FORECAST[currentDay];const segs=day.hours.map(h=>{const s=scoreHour(h,currentSkill);return{hour:h.hour,...s,data:h};});const peakWind=Math.max(...segs.map(s=>s.ws));const maxWind=Math.ceil((peakWind+5)/5)*5;const windBarsHtml=segs.map((s,i)=>{const pct=Math.min(100,(s.ws/maxWind)*100);const sel=selectedHour===s.hour;const tip=`<div class="tl-tip"><strong>${s.hour===0?'12am':s.hour===12?'12pm':s.hour>12?(s.hour-12)+'pm':s.hour+'am'}</strong> ‚Äî <span style="color:${s.rating.color};font-weight:700">${s.rating.label}</span> (${s.score}/100)<br>Wind: ${Math.round(s.ws)} kts (gusts ${Math.round(s.gs)})<br>Waves: ${s.data.waveHeight.toFixed(1)}m ¬∑ Dir: ${d2c(s.data.windDir)}${s.data.thunderstorm?'<br>‚ö° Thunderstorm risk':''}</div>`;const icons=[];
if(s.data.thunderstorm){icons.push('<svg width="12" height="12" viewBox="0 0 16 16"><path d="M4 6a4 4 0 017.3-2.1 3 3 0 011.7 5.1H3a3 3 0 01-1.4-5.6A4 4 0 014 6z" fill="none" stroke="currentColor" stroke-width="1.1"/><path d="M8.5 8L6.5 11.5h2.5L7.5 15" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>');}
else if(s.data.precip>2){icons.push('<svg width="12" height="12" viewBox="0 0 16 16"><path d="M4 6a4 4 0 017.3-2.1 3 3 0 011.7 5.1H3a3 3 0 01-1.4-5.6A4 4 0 014 6z" fill="none" stroke="currentColor" stroke-width="1.1"/><path d="M5 12v1.5M8 11.5v2M11 12v1.5" stroke="currentColor" stroke-width="1" stroke-linecap="round"/></svg>');}
else if(s.data.precip>0.3){icons.push('<svg width="12" height="12" viewBox="0 0 16 16"><path d="M4 6a4 4 0 017.3-2.1 3 3 0 011.7 5.1H3a3 3 0 01-1.4-5.6A4 4 0 014 6z" fill="none" stroke="currentColor" stroke-width="1.1"/><path d="M8 12v1.5" stroke="currentColor" stroke-width="1" stroke-linecap="round"/></svg>');}
else if(s.hour<6||s.hour>=20){icons.push('<svg width="11" height="11" viewBox="0 0 20 20"><path d="M12 3C7 3 3 7 3 12s4 9 9 9c3.5 0 6.5-2 8-5-1 .5-2.2.8-3.4.8C11.4 16.8 7.2 12.6 7.2 7.4c0-1.2.3-2.4.8-3.4C8 3 10 3 12 3z" fill="none" stroke="currentColor" stroke-width="1.2"/></svg>');}
else if(s.data.cloud>75){icons.push('<svg width="12" height="11" viewBox="0 0 16 14"><path d="M4 7a4 4 0 017.3-2.1 3 3 0 011.7 5.1H3a3 3 0 01-1.4-5.6A4 4 0 014 7z" fill="none" stroke="currentColor" stroke-width="1.2"/></svg>');}
else if(s.data.cloud>40){icons.push('<svg width="12" height="12" viewBox="0 0 16 16"><circle cx="6" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1.1"/><path d="M3.5 5H2M6 2.5V1M8.5 5H10M4 3L3 2M8 3l1-1" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/><path d="M6 9a3 3 0 015.5-1.6 2.2 2.2 0 011.3 3.8H5a2.2 2.2 0 01-1-4.2" fill="none" stroke="currentColor" stroke-width="1.1"/></svg>');}
else{icons.push('<svg width="12" height="12" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4" fill="none" stroke="currentColor" stroke-width="1.3"/><line x1="10" y1="2" x2="10" y2="4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><line x1="10" y1="16" x2="10" y2="18" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><line x1="2" y1="10" x2="4" y2="10" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><line x1="16" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><line x1="4.3" y1="4.3" x2="5.7" y2="5.7" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><line x1="14.3" y1="14.3" x2="15.7" y2="15.7" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><line x1="4.3" y1="15.7" x2="5.7" y2="14.3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><line x1="14.3" y1="5.7" x2="15.7" y2="4.3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>');}
const iconStr=icons.length?'<span class="tl-bar-icons">'+icons.join('')+'</span>':'';return`<div class="tl-unified" style="flex:1;display:flex;flex-direction:column;justify-content:flex-end;height:180px;cursor:pointer;position:relative" onclick="selectedHour=${s.hour};renderCurrent();renderTimeline();updateWindyTime()"><span class="tl-kt ${sel?'tl-kt-sel':''}">${Math.round(s.ws)}</span><div class="tl-ubar" style="background:${s.rating.color};height:${Math.max(10,pct)}%;${sel?'opacity:1;transform:scaleX(1.05);box-shadow:0 0 0 2px #1a2332;z-index:2;':'opacity:0.8;'}">${iconStr}${tip}</div></div>`;}).join("");const segHtml="";const hrs=segs.filter((_,i)=>i%3===0).map(s=>{const h=s.hour;return`<span class="tl-hour">${h===0?'12a':h===12?'12p':h>12?(h-12)+'p':h+'a'}</span>`;}).join("");const daylight=segs.filter(s=>s.hour>=6&&s.hour<=20);let bS=-1,bL=0,cS=-1,cL=0;daylight.forEach((s,i)=>{if(s.score>=40){if(cS<0)cS=i;cL++;if(cL>bL){bL=cL;bS=cS;}}else{cS=-1;cL=0;}});let wt="";if(bL>=2){const from=daylight[bS].hour,to=daylight[bS+bL-1].hour;const fH=h=>h===0?'12am':h===12?'12pm':h>12?(h-12)+'pm':h+'am';wt=`Best sailing window: <strong>${fH(from)}‚Äì${fH(to)}</strong> (${bL} hours of Good or better conditions)`;}else if(bL===1){wt="Very limited sailing window today.";}else{wt="No recommended sailing window today.";}document.getElementById("timeline-section").innerHTML=`<div class="tl-label-row"><span class="tl-label">Conditions Timeline ¬∑ Click to inspect</span><span class="tl-label">${day.windDesc}</span></div><div style="font-size:9px;color:#a0a8b8;text-transform:uppercase;letter-spacing:.6px;font-weight:600;margin-bottom:2px">Wind (kts)</div><div class="tl-graph-wrap"><div class="tl-yaxis">${Array.from({length:maxWind/5+1},(_,i)=>{const v=i*5;const pct=(v/maxWind)*100;return`<span class="tl-ytick" style="bottom:${pct}%">${v}</span>`;}).join('')}<span class="tl-ylabel">kts</span></div><div class="tl-graph-area"><div class="tl-gridlines">${Array.from({length:maxWind/5},(_,i)=>{const pct=((i+1)*5/maxWind)*100;return`<div class="tl-gridline" style="bottom:${pct}%"></div>`;}).join('')}<div class="tl-ideal-band" style="bottom:${(SKILLS[currentSkill].windIdealMin/maxWind)*100}%;height:${((SKILLS[currentSkill].windIdealMax-SKILLS[currentSkill].windIdealMin)/maxWind)*100}%"></div></div><div class="tl-unified-wrap">${windBarsHtml}</div></div></div><div class="tl-hours">${hrs}</div><div class="tl-summary">${wt}${selectedHour!==null?' <span style="color:#a0a8b8;font-size:11px;cursor:pointer;text-decoration:underline" onclick="selectedHour=null;renderCurrent();renderTimeline();updateWindyTime()">Clear selection</span>':''}</div><div class="tl-summary" style="font-size:12px;color:#7a8599;margin-top:2px">${day.summary}</div>`;}

function renderLegend(){const tiers=[{label:"Poor",score:"0‚Äì20",color:"#e74c3c",desc:"Too light, too strong, or unsafe. Stay ashore."},{label:"Okay",score:"20‚Äì40",color:"#e88d1a",desc:"Sailable but unenjoyable. Low or gusty wind."},{label:"Good",score:"40‚Äì60",color:"#f5a623",desc:"Worth going out. Decent wind, manageable chop."},{label:"Great",score:"60‚Äì80",color:"#1db954",desc:"Rearrange your day. Steady wind, flat bay."},{label:"Excellent",score:"80‚Äì100",color:"#7c3aed",desc:"Rare. Everything lines up perfectly."}];const sk=SKILLS[currentSkill];document.getElementById("legend").innerHTML=`<div class="legend-title">Rating Scale ¬∑ ${sk.label} (Wind ${sk.windIdealMin}‚Äì${sk.windIdealMax} kts ideal, Gusts ‚â§${sk.gustIdealMax} kts, Waves ‚â§${sk.waveIdealMax}m)</div><div class="legend-grid">${tiers.map((t,i)=>`<div class="legend-card"><div class="legend-card-label" style="color:${t.color}">${t.label}</div><div class="legend-card-score">${t.score}</div><div class="legend-card-dots">${Array.from({length:5},(_,j)=>`<div class="legend-card-dot" style="background:${j<=i?t.color:'#e0e3e8'}"></div>`).join("")}</div><div class="legend-card-desc">${t.desc}</div></div>`).join("")}</div><div style="margin-top:12px;font-size:11px;color:#7a8599;line-height:1.6"><strong style="color:#5a6577">Zone wind direction:</strong> ${(ZONE_DIR[ZONES[currentZone].id]||{desc:""}).desc}</div>`;}

let map=null,mapOpen=false,customMarker=null,customLoc=null;

function toggleMap(){
  mapOpen=!mapOpen;
  document.getElementById("map-wrap").classList.toggle("open",mapOpen);
  document.getElementById("map-toggle").classList.toggle("active",mapOpen);
  if(mapOpen&&!map)initMap();
  if(map)setTimeout(()=>map.invalidateSize(),100);
}

function initMap(){
  if(!document.getElementById("map")){console.log("Location picker map div not found, skipping");return;}map=L.map("map",{zoomControl:true,scrollWheelZoom:true}).setView([-37.88,144.95],11);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains:'abcd',maxZoom:16
  }).addTo(map);

  // Add marina markers
  const marinas=[
    {name:"RMYS St Kilda Marina",lat:-37.8676,lon:144.9741,idx:0},
    {name:"Savages Wharf, Williamstown",lat:-37.8654,lon:144.8985,idx:1},
    {name:"Sandringham Yacht Club",lat:-37.9508,lon:145.0095,idx:2},
    {name:"Royal Brighton Yacht Club",lat:-37.9075,lon:144.9865,idx:3},
    {name:"Blairgowrie Yacht Squadron",lat:-38.3580,lon:144.7730,idx:4}
  ];

  marinas.forEach(m=>{
    const icon=L.divIcon({className:'',html:'<div class="marina-marker"></div>',iconSize:[10,10],iconAnchor:[5,5]});
    const marker=L.marker([m.lat,m.lon],{icon}).addTo(map);
    marker.bindTooltip(m.name,{direction:'top',offset:[0,-8]});
    marker.on('click',()=>{
      currentZone=m.idx;
      customLoc=null;
      if(customMarker){map.removeLayer(customMarker);customMarker=null;}
      document.getElementById("map-loc-name").textContent=m.name;
      document.getElementById("map-coords").textContent=m.lat.toFixed(4)+", "+m.lon.toFixed(4);
      

// ==================== WEATHER MAP ====================
let wxMap = null;
let wxLayer = "wind";
let wxMarkers = [];
let wxGridData = null;

const WX_COLORS = {
  wind: [
    {min:0,max:3,color:"#a8e6cf"},
    {min:3,max:6,color:"#5cb85c"},
    {min:6,max:10,color:"#1db954"},
    {min:10,max:15,color:"#f5a623"},
    {min:15,max:20,color:"#e88d1a"},
    {min:20,max:25,color:"#e74c3c"},
    {min:25,max:40,color:"#c0392b"}
  ],
  gust: [
    {min:0,max:5,color:"#a8e6cf"},
    {min:5,max:10,color:"#5cb85c"},
    {min:10,max:15,color:"#1db954"},
    {min:15,max:20,color:"#f5a623"},
    {min:20,max:30,color:"#e88d1a"},
    {min:30,max:40,color:"#e74c3c"},
    {min:40,max:60,color:"#c0392b"}
  ],
  rain: [
    {min:0,max:0.1,color:"#f0f1f3"},
    {min:0.1,max:0.5,color:"#bde0fe"},
    {min:0.5,max:1,color:"#7cc4fa"},
    {min:1,max:3,color:"#4da6ff"},
    {min:3,max:5,color:"#2176cc"},
    {min:5,max:10,color:"#1a4f8a"},
    {min:10,max:30,color:"#0d2b4d"}
  ]
};

function getWxColor(value, layer) {
  const scale = WX_COLORS[layer] || WX_COLORS.wind;
  for (const s of scale) {
    if (value >= s.min && value < s.max) return s.color;
  }
  return scale[scale.length - 1].color;
}

function initWxMap() {
  if (wxMap) return;
  const el = document.getElementById("wx-map");
  if (!el) { console.error("wx-map element not found"); return; }
  console.log("Initializing weather map, element height:", el.offsetHeight);
  if(!document.getElementById("wx-map")){console.error("wx-map not found");return;}wxMap = L.map("wx-map", {zoomControl: true, scrollWheelZoom: true}).setView([-37.88, 144.92], 10);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    attribution: '&copy; OSM &copy; CARTO',
    subdomains: 'abcd', maxZoom: 14
  }).addTo(wxMap);

  // Add marina markers
  const marinas = [
    {name:"RMYS St Kilda",lat:-37.8676,lon:144.9741},
    {name:"Savages Wharf",lat:-37.8654,lon:144.8985},
    {name:"Sandringham YC",lat:-37.9508,lon:145.0095},
    {name:"Royal Brighton YC",lat:-37.9075,lon:144.9865},
    {name:"Blairgowrie YS",lat:-38.3580,lon:144.7730}
  ];
  marinas.forEach(m => {
    const icon = L.divIcon({className:"",html:'<div style="width:8px;height:8px;background:#1a2332;border:2px solid #fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,0.3)"></div>',iconSize:[8,8],iconAnchor:[4,4]});
    L.marker([m.lat, m.lon], {icon}).addTo(wxMap).bindTooltip(m.name, {direction:"top",offset:[0,-8]});
  });

  fetchWxGrid();
}

async function fetchWxGrid() {
  console.log("Fetching weather grid data...");
  // Grid of points across Port Phillip Bay
  const points = [];
  for (let lat = -38.35; lat <= -37.82; lat += 0.06) {
    for (let lon = 144.55; lon <= 145.10; lon += 0.06) {
      points.push({lat: Math.round(lat * 1000) / 1000, lon: Math.round(lon * 1000) / 1000});
    }
  }

  // Batch fetch via Open-Meteo (supports multiple coords in one call isn't available,
  // so we'll use a reasonable grid and fetch them as individual quick calls)
  // Actually Open-Meteo doesn't support batch, but we can construct a single call
  // per lat/lon. For performance, let's use fewer points.
  const sparsePoints = [];
  for (let lat = -38.30; lat <= -37.83; lat += 0.10) {
    for (let lon = 144.58; lon <= 145.08; lon += 0.10) {
      sparsePoints.push({lat: Math.round(lat * 100) / 100, lon: Math.round(lon * 100) / 100});
    }
  }

  document.getElementById("wx-info-bar").innerHTML = "<span>Fetching wind data for " + sparsePoints.length + " grid points...</span>";

  try {
    // Fetch all points in parallel with a slight stagger
    const results = await Promise.allSettled(
      sparsePoints.map((p, i) =>
        new Promise(resolve => setTimeout(() => {
          fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.lat}&longitude=${p.lon}&hourly=wind_speed_10m,wind_direction_10m,wind_gusts_10m,precipitation&timezone=Australia/Melbourne&forecast_days=7`)
            .then(r => { if(!r.ok) throw new Error(r.status); return r.json(); })
            .then(data => resolve({...p, data}))
            .catch(e => { console.warn("Grid point failed:", p.lat, p.lon, e.message); resolve({...p, data: null}); });
        }, i * 50))
      )
    );

    wxGridData = results
      .filter(r => r.status === "fulfilled" && r.value.data && !r.value.data.error)
      .map(r => r.value);

    document.getElementById("wx-info-bar").innerHTML = '<span>Open-Meteo ECMWF ¬∑ ' + wxGridData.length + ' grid points ¬∑ <a href="https://open-meteo.com" target="_blank">open-meteo.com</a> ¬∑ CC-BY 4.0 ¬∑ Click timeline to change time</span>';

    renderWxLayer();
  } catch (e) {
    document.getElementById("wx-info-bar").innerHTML = "<span>Failed to load weather grid: " + e.message + "</span>";
  }
}

function renderWxLayer() {
  if (!wxMap || !wxGridData) return;

  // Clear existing markers
  wxMarkers.forEach(m => wxMap.removeLayer(m));
  wxMarkers = [];

  // Determine which hour index to show
  const day = FORECAST[currentDay];
  if (!day) return;
  const hour = selectedHour !== null ? selectedHour : (currentDay === 0 ? Math.max(5, Math.min(22, new Date().getHours())) : 12);
  const targetTime = day.date + "T" + String(hour).padStart(2, "0") + ":00";

  wxGridData.forEach(point => {
    if (!point.data || !point.data.hourly) return;

    const timeIdx = point.data.hourly.time.indexOf(targetTime);
    if (timeIdx < 0) return;

    const ws = point.data.hourly.wind_speed_10m[timeIdx]; // km/h
    const wd = point.data.hourly.wind_direction_10m[timeIdx];
    const gs = point.data.hourly.wind_gusts_10m[timeIdx];
    const pr = point.data.hourly.precipitation[timeIdx];
    const wsKt = ws * 0.539957;
    const gsKt = gs * 0.539957;

    let value, label;
    if (wxLayer === "gust") { value = gsKt; label = Math.round(gsKt); }
    else if (wxLayer === "rain") { value = pr; label = pr > 0.1 ? pr.toFixed(1) : ""; }
    else { value = wsKt; label = Math.round(wsKt); }

    const color = getWxColor(value, wxLayer);

    if (wxLayer === "rain" && pr < 0.1) return; // Skip dry points for rain layer

    // Wind arrow SVG
    let markerHtml;
    if (wxLayer === "rain") {
      const size = Math.max(16, Math.min(36, pr * 8));
      markerHtml = `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${color};opacity:0.6;display:flex;align-items:center;justify-content:center;font-size:8px;color:#fff;font-weight:700;font-family:'Space Mono',monospace">${label}</div>`;
    } else {
      const arrowLen = Math.max(14, Math.min(32, value * 1.3));
      markerHtml = `<div style="display:flex;flex-direction:column;align-items:center;transform:rotate(${wd}deg)">
        <svg width="14" height="${arrowLen}" viewBox="0 0 14 ${arrowLen}">
          <line x1="7" y1="0" x2="7" y2="${arrowLen}" stroke="${color}" stroke-width="2.5" stroke-linecap="round"/>
          <path d="M3 5L7 0L11 5" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div style="position:absolute;bottom:-12px;left:50%;transform:translateX(-50%) rotate(-${wd}deg);font-size:8px;color:#1a2332;font-weight:600;font-family:'Space Mono',monospace;text-shadow:0 0 3px #fff,0 0 3px #fff">${label}</div>`;
    }

    const icon = L.divIcon({
      className: "",
      html: `<div style="position:relative;display:flex;align-items:center;justify-content:center">${markerHtml}</div>`,
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });

    const marker = L.marker([point.lat, point.lon], {icon, interactive: false}).addTo(wxMap);
    wxMarkers.push(marker);
  });

  // Render legend
  renderWxLegend();

  // Update info bar time
  const timeLabel = selectedHour !== null
    ? (hour === 0 ? "12am" : hour === 12 ? "12pm" : hour > 12 ? (hour-12)+"pm" : hour+"am")
    : "now";
  const infoEl = document.getElementById("wx-info-bar");
  if (infoEl && wxGridData.length > 0) {
    infoEl.innerHTML = `<span>Showing: <strong>${day.label} ${timeLabel}</strong> ¬∑ Open-Meteo ECMWF ¬∑ ${wxGridData.length} points ¬∑ <a href="https://open-meteo.com" target="_blank">open-meteo.com</a> CC-BY 4.0</span>`;
  }
}

function renderWxLegend() {
  const scale = WX_COLORS[wxLayer] || WX_COLORS.wind;
  const unit = wxLayer === "rain" ? "mm" : "kts";
  const title = wxLayer === "rain" ? "Precipitation" : wxLayer === "gust" ? "Wind Gusts" : "Wind Speed";

  const barHtml = scale.map(s => `<div style="flex:1;background:${s.color}"></div>`).join("");
  const labels = [scale[0].min, ...scale.map(s => s.max)];
  const labelHtml = `<span>${labels[0]}</span>` + scale.map(s => `<span>${s.max}</span>`).join("");

  document.getElementById("wx-map-legend").innerHTML = `
    <div class="wx-map-legend-title">${title} (${unit})</div>
    <div class="wx-map-legend-bar">${barHtml}</div>
    <div class="wx-map-legend-labels">${labelHtml}</div>`;
}

function setWxLayer(layer) {
  wxLayer = layer;
  document.querySelectorAll("#wx-layer-btns .map-layer-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.layer === layer);
  });
  renderWxLayer();
}



function updateWindyTime(){if(wxMap&&wxGridData)renderWxLayer();}

renderAll();
setTimeout(initWxMap, 500);
</script></body></html>
